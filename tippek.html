<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VSPORT – AI Tippek</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #080808;
      --surface: #0f0f0f;
      --surface2: #151515;
      --border: #1e1e1e;
      --border2: #2a2a2a;
      --text: #e8e8e8;
      --text-dim: #666;
      --text-muted: #333;
      --green: #4caf50;
      --green-dim: #1e6b1e;
      --red: #e53935;
      --amber: #f59e0b;
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden; }

    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 0;
      pointer-events: none; opacity: 0.025;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      background-size: 200px;
      animation: grain 0.5s steps(1) infinite;
    }
    @keyframes grain { 0%{transform:translate(0,0)} 10%{transform:translate(-2%,-2%)} 20%{transform:translate(2%,2%)} 30%{transform:translate(-1%,1%)} 40%{transform:translate(1%,-1%)} 50%{transform:translate(-2%,1%)} 60%{transform:translate(2%,-2%)} 70%{transform:translate(-1%,-1%)} 80%{transform:translate(1%,2%)} 90%{transform:translate(-2%,2%)} 100%{transform:translate(2%,-1%)} }

    body::after {
      content: ''; position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    }

    /* ── Header ── */
    header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(8,8,8,0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 0 24px; height: 52px;
      display: flex; align-items: center; gap: 14px;
    }

    .live-dot {
      width: 8px; height: 8px; border-radius: 50%; background: #fff;
      box-shadow: 0 0 0 0 rgba(255,255,255,0.4);
      animation: livePulse 2s infinite;
    }
    @keyframes livePulse {
      0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); }
      70% { box-shadow: 0 0 0 6px rgba(255,255,255,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }

    .header-sep { width: 1px; height: 20px; background: var(--border2); }

    .site-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.4rem; letter-spacing: 4px; color: #fff;
      text-shadow: 0 0 20px rgba(255,255,255,0.15);
    }

    .back-btn {
      display: flex; align-items: center; gap: 7px;
      color: var(--text-dim); font-size: .65rem; text-decoration: none;
      font-family: 'DM Mono', monospace; letter-spacing: 1px;
      padding: 5px 12px; border: 1px solid var(--border2); border-radius: 2px;
      transition: all .15s;
    }
    .back-btn:hover { color: #fff; border-color: #555; }
    .back-icon { width: 12px; height: 12px; }

    @keyframes fadeDown { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
    @keyframes fadeUp   { from{opacity:0;transform:translateY(8px)}  to{opacity:1;transform:translateY(0)} }
    @keyframes fadeIn   { from{opacity:0} to{opacity:1} }

    /* ── Page ── */
    .page {
      position: relative; z-index: 1;
      max-width: 940px; margin: 0 auto; padding: 28px 20px 60px;
      animation: fadeUp 0.5s ease both;
    }

    /* ── Tabs ── */
    .tabs {
      display: flex; gap: 0; margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }
    .tab {
      background: none; border: none; border-bottom: 2px solid transparent;
      color: var(--text-dim); font-size: .68rem;
      font-family: 'DM Mono', monospace; letter-spacing: 1.5px;
      padding: 10px 20px; cursor: pointer; transition: all .15s;
      text-transform: uppercase; display: flex; align-items: center; gap: 8px;
      position: relative; top: 1px;
    }
    .tab:hover { color: #aaa; }
    .tab.active { color: #fff; border-bottom-color: #fff; }
    .tab-icon { width: 14px; height: 14px; }

    /* ── AI badge ── */
    .ai-badge {
      background: var(--green-dim, #1e6b1e); color: #fff;
      font-size: .55rem; font-family: 'DM Mono', monospace;
      padding: 2px 8px; border-radius: 2px; letter-spacing: 1px;
      animation: livePulse 2s infinite;
    }

    /* ── Section header ── */
    .section-hdr {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 14px;
    }
    .section-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.1rem; letter-spacing: 3px; color: var(--text);
      display: flex; align-items: center; gap: 10px;
    }
    .section-title-icon { width: 18px; height: 18px; opacity: 0.8; }

    /* ── Leaderboard ── */
    .leaderboard-block {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 2px; overflow: hidden; margin-bottom: 16px;
    }
    .leaderboard-header-bar {
      background: linear-gradient(90deg, #1a4d1a 0%, #1e6b1e 100%);
      display: grid;
      grid-template-columns: 28px 18px 1fr 80px 46px 38px;
      align-items: center; padding: 8px 12px; gap: 4px;
      border-bottom: 1px solid rgba(76,175,80,0.2);
    }
    .leaderboard-header-bar span {
      font-family: 'DM Mono', monospace;
      font-size: .55rem; color: rgba(255,255,255,0.65);
      text-transform: uppercase; letter-spacing: .5px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .leaderboard-header-bar .h-right { text-align: right; }

    .lb-meta {
      background: #0a0a0a; border-bottom: 1px solid var(--border);
      padding: 4px 12px; font-size: .58rem; color: var(--text-muted);
      display: flex; justify-content: space-between; align-items: center;
      font-family: 'DM Mono', monospace;
    }
    .refresh-dot {
      width: 5px; height: 5px; border-radius: 50%;
      background: var(--green); display: inline-block;
      margin-right: 5px; animation: livePulse 2s infinite;
    }
    .lb-meta.loading .refresh-dot { background: var(--amber); }
    .lb-meta.error   .refresh-dot { background: var(--red); }

    .leaderboard-body { background: var(--surface); }

    .lb-row {
      display: grid;
      grid-template-columns: 28px 18px 1fr 80px 46px 38px;
      align-items: center; padding: 5px 12px; gap: 4px;
      border-bottom: 1px solid var(--border);
      transition: background .12s;
      animation: fadeIn 0.3s ease both;
    }
    .lb-row:last-child { border-bottom: none; }
    .lb-row:hover { background: var(--surface2); }
    .lb-row.top3 {
      background: linear-gradient(90deg, rgba(30,107,30,0.15) 0%, transparent 100%);
    }
    .lb-row.top3:hover { background: rgba(30,107,30,0.2); }
    .lb-row.relegation {
      background: linear-gradient(90deg, rgba(229,57,53,0.08) 0%, transparent 100%);
    }
    .lb-row.relegation:hover { background: rgba(229,57,53,0.12); }

    .col-pos { font-family: 'DM Mono', monospace; font-size: .68rem; color: var(--text-dim); text-align: center; }
    .lb-row.top3 .col-pos { color: var(--green); }
    .lb-row.relegation .col-pos { color: var(--red); }

    .col-trend { display: flex; align-items: center; justify-content: center; }
    .trend-up   { color: var(--green); font-size: .5rem; }
    .trend-down { color: var(--red);   font-size: .5rem; }
    .trend-same { color: #252525;      font-size: .5rem; }

    .col-team { display: flex; align-items: center; gap: 7px; min-width: 0; }
    .team-logo { width: 16px; height: 16px; object-fit: contain; flex-shrink: 0; }
    .team-logo-placeholder { width: 16px; height: 16px; flex-shrink: 0; background: #1a1a1a; border-radius: 50%; }
    .team-name { font-size: .74rem; font-weight: 600; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .col-goals { font-family: 'DM Mono', monospace; font-size: .65rem; color: var(--text-dim); text-align: right; }
    .col-gd    { font-family: 'DM Mono', monospace; font-size: .63rem; color: var(--text-muted); text-align: right; }
    .col-pts   { font-family: 'DM Mono', monospace; font-size: .78rem; font-weight: 500; color: #fff; text-align: right; }

    /* ── AI Panel ── */
    .aipanel {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 2px; overflow: hidden; margin-top: 16px;
    }
    .aipanel-hdr {
      background: var(--surface2); border-bottom: 1px solid var(--border);
      padding: 10px 16px; display: flex; align-items: center; gap: 10px;
    }
    .aipanel-icon { width: 16px; height: 16px; }
    .aipanel-title {
      font-family: 'DM Mono', monospace;
      font-size: .65rem; font-weight: 500; letter-spacing: 1.5px;
      text-transform: uppercase; color: var(--text);
    }
    .aibody {
      padding: 18px 20px; font-size: .82rem; line-height: 1.8;
      color: #999; min-height: 80px;
    }

    /* ── Season notice ── */
    .season-notice {
      display: flex; align-items: center; gap: 10px;
      background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2);
      border-radius: 2px; padding: 10px 14px; margin-bottom: 16px;
      font-size: .72rem; color: var(--amber);
      font-family: 'DM Mono', monospace; letter-spacing: 0.5px;
    }
    .season-notice-icon { width: 14px; height: 14px; flex-shrink: 0; }

    /* ── Loading dots ── */
    .dots { display: flex; gap: 6px; padding: 16px 0; justify-content: center; }
    .dots span {
      width: 6px; height: 6px; border-radius: 50%; background: #fff;
      opacity: .15; animation: dotPulse 1.2s infinite;
    }
    .dots span:nth-child(2){ animation-delay:.2s; }
    .dots span:nth-child(3){ animation-delay:.4s; }
    @keyframes dotPulse { 0%,100%{opacity:.15} 50%{opacity:.8} }

    /* ── Error box ── */
    .error-box {
      display: none;
      background: rgba(229,57,53,0.08); border: 1px solid rgba(229,57,53,0.2);
      border-radius: 2px; padding: 12px 16px; font-size: .75rem;
      color: #ff8a80; margin-bottom: 16px;
      font-family: 'DM Mono', monospace;
    }
    .error-box.show { display: flex; align-items: center; gap: 8px; }
    .error-icon { width: 14px; height: 14px; flex-shrink: 0; }

    /* ── Button ── */
    .btn {
      display: flex; align-items: center; gap: 7px;
      background: var(--surface2); border: 1px solid var(--border2);
      color: var(--text-dim); font-size: .65rem;
      font-family: 'DM Mono', monospace; letter-spacing: 1px;
      padding: 7px 14px; border-radius: 2px;
      cursor: pointer; transition: all .15s; text-transform: uppercase;
    }
    .btn:hover { background: #1a1a1a; border-color: #555; color: #fff; }
    .btn-icon { width: 13px; height: 13px; }
  </style>
</head>
<body>

<header>
  <div class="live-dot"></div>
  <div class="header-sep"></div>
  <span class="site-title">VSPORT</span>
  <div class="header-sep"></div>
  <a class="back-btn" href="/">
    <!-- Back arrow SVG -->
    <svg class="back-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    Vissza
  </a>
</header>

<div class="page">

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" id="realTab" onclick="showRealTable()">
      <!-- Chart SVG -->
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 3v18h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        <path d="M7 16l4-4 4 4 4-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Valódi tabella
    </button>
    <button class="tab" id="aiTab" onclick="showAITable()">
      <!-- AI star SVG -->
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
        <path d="M19 16L19.6 18.4L22 19L19.6 19.6L19 22L18.4 19.6L16 19L18.4 18.4L19 16Z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/>
      </svg>
      AI Elemzett tabella
    </button>
  </div>

  <!-- VALÓDI TABELLA -->
  <div id="realTableContainer">
    <div class="section-hdr">
      <div class="section-title">
        <!-- Lightning SVG -->
        <svg class="section-title-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M13 2L4.5 13.5H11L10 22L19.5 10.5H13L13 2Z" fill="white" stroke="white" stroke-width="1" stroke-linejoin="round"/>
        </svg>
        Premier Liga
      </div>
      <button class="btn" id="refreshRealBtn">
        <!-- Refresh SVG -->
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M1 4v6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M3.51 15a9 9 0 102.13-9.36L1 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Frissítés
      </button>
    </div>

    <div class="leaderboard-block">
      <div class="leaderboard-header-bar">
        <span>#</span><span></span><span>Csapat</span>
        <span class="h-right">Lőtt–Kapott</span>
        <span class="h-right">GD</span>
        <span class="h-right">Pont</span>
      </div>
      <div class="lb-meta loading" id="realMeta">
        <span><span class="refresh-dot"></span>Betöltés...</span>
        <span id="realUpdateTime">–</span>
      </div>
      <div class="leaderboard-body" id="realTable">
        <div style="padding:24px; text-align:center; color:var(--text-muted); font-size:.72rem; font-family:'DM Mono',monospace">Betöltés...</div>
      </div>
    </div>
  </div>

  <!-- AI TABELLA -->
  <div id="aiTableContainer" style="display: none;">
    <div class="section-hdr">
      <div class="section-title">
        <svg class="section-title-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" fill="white" stroke="white" stroke-width="0.5"/>
        </svg>
        AI Előrejelzés
        <span class="ai-badge">LLM7</span>
      </div>
      <button class="btn" id="generateAIBtn">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
        </svg>
        Generálás
      </button>
    </div>

    <!-- Season notice (hidden by default) -->
    <div class="season-notice" id="seasonNotice" style="display:none;">
      <svg class="season-notice-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 9v4M12 17h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span id="seasonNoticeText">Új szezon érzékelve – az AI az új adatok alapján elemez</span>
    </div>

    <div class="leaderboard-block">
      <div class="leaderboard-header-bar">
        <span>#</span><span></span><span>Csapat</span>
        <span class="h-right">Lőtt–Kapott</span>
        <span class="h-right">GD</span>
        <span class="h-right">Pont</span>
      </div>
      <div class="lb-meta" id="aiMeta">
        <span><span class="refresh-dot"></span>AI becslés</span>
        <span id="aiUpdateTime">–</span>
      </div>
      <div class="leaderboard-body" id="aiTable">
        <div style="padding:32px; text-align:center; color:var(--text-muted); font-size:.72rem; font-family:'DM Mono',monospace; line-height:2">
          Kattints a "Generálás" gombra<br>
          <span style="color:#222; font-size:.6rem">Az AI elemzi a valós adatokat és saját előrejelzést készít</span>
        </div>
      </div>
    </div>

    <div class="aipanel" id="aiPanel" style="display:none;">
      <div class="aipanel-hdr">
        <svg class="aipanel-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="aipanel-title">AI Elemzés</span>
        <span class="ai-badge" style="margin-left:auto">llm7.io</span>
      </div>
      <div class="aibody" id="aiBody"></div>
    </div>
  </div>

  <div class="error-box" id="errorBox">
    <svg class="error-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
      <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    <span id="errorText"></span>
  </div>

</div><!-- .page -->

<script>
const LLM7_URL = 'https://api.llm7.io/v1/chat/completions';
const LLM7_KEY = '/WF1cs8NieiVJAvBfBR+n5Fb/vxRW1oSmv3EqtTSTRxWQBGMexqcI4Xivs+BqTXfNYMZI8OUFZpv5YAA0FOjcumYWgcG8AkhePVVO8zCVKQo3GMYfArXw2yPPKY7w3tRvofNvQ==';

let realStandings = [];
let lastSeasonId = null;
let lastTotalPoints = null; // szezonváltás detektáláshoz

// ── LLM7 hívás ──────────────────────────────────────────────
async function callAI(prompt) {
  const res = await fetch(LLM7_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${LLM7_KEY}`
    },
    body: JSON.stringify({
      model: 'default',
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.9,
      max_tokens: 4096
    })
  });
  if (!res.ok) throw new Error(`LLM7 hiba: ${res.status}`);
  const data = await res.json();
  return data.choices?.[0]?.message?.content || '';
}

// ── Segédfüggvények ──────────────────────────────────────────
function gd(gf, ga) {
  const diff = (gf || 0) - (ga || 0);
  if (diff > 0) return `<span style="color:#4caf50">+${diff}</span>`;
  if (diff < 0) return `<span style="color:#e53935">${diff}</span>`;
  return `<span style="color:#2a2a2a">0</span>`;
}
function trendHtml(t) {
  if (t === 'up')   return '<span class="trend-up">▲</span>';
  if (t === 'down') return '<span class="trend-down">▼</span>';
  return '<span class="trend-same">—</span>';
}
function logoHtml(logo) {
  if (!logo) return '<span class="team-logo-placeholder"></span>';
  return `<img class="team-logo" src="${logo}" alt="" loading="lazy" onerror="this.style.display='none'">`;
}
function rowClass(pos, total) {
  if (pos <= 3) return 'lb-row top3';
  if (total && pos > total - 3) return 'lb-row relegation';
  return 'lb-row';
}

// ── JSON kinyerő (robusztus) ──────────────────────────────────
function extractJSONArray(text) {
  let s = text.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
  const start = s.indexOf('[');
  if (start === -1) throw new Error('Nem található JSON tömb');
  s = s.slice(start);
  try { return JSON.parse(s).map(normalizeTeam); } catch (_) {}

  // Ha csonkított: objektumokat egyenként mentjük ki
  const objects = [];
  let depth = 0, inStr = false, escape = false, objStart = -1;
  for (let i = 0; i < s.length; i++) {
    const c = s[i];
    if (escape) { escape = false; continue; }
    if (c === '\\' && inStr) { escape = true; continue; }
    if (c === '"') { inStr = !inStr; continue; }
    if (inStr) continue;
    if (c === '{') { if (depth === 0) objStart = i; depth++; }
    else if (c === '}') {
      depth--;
      if (depth === 0 && objStart !== -1) {
        try { objects.push(JSON.parse(s.slice(objStart, i + 1))); } catch (_) {}
        objStart = -1;
      }
    }
  }
  if (objects.length > 0) return objects.map(normalizeTeam);
  throw new Error('Nem sikerült érvényes adatokat kinyerni');
}

// "points" / "pts" / "point" egységesítése
function normalizeTeam(r) {
  return {
    pos:          r.pos,
    team:         r.team,
    goalsFor:     r.goalsFor  ?? r.goals_for      ?? 0,
    goalsAgainst: r.goalsAgainst ?? r.goals_against ?? 0,
    pts:          r.pts       ?? r.points         ?? r.point ?? 0,
    trend:        r.trend     ?? 'same'
  };
}

// ── Szezonváltás detektálás ──────────────────────────────────
function detectSeasonReset(standings, serverSeasonId) {
  const totalPoints = standings.reduce((s, t) => s + (t.pts || 0), 0);
  let isReset = false;

  // Ha szerver visszaküldi a szezon ID-t és változott
  if (serverSeasonId && lastSeasonId && serverSeasonId !== lastSeasonId) {
    isReset = true;
  }
  // Ha az összes pont drasztikusan lecsökkent (pl. 900 -> 30 = új szezon)
  if (lastTotalPoints !== null && lastTotalPoints > 100 && totalPoints < lastTotalPoints * 0.3) {
    isReset = true;
  }

  if (isReset) {
    const notice = document.getElementById('seasonNotice');
    const noticeText = document.getElementById('seasonNoticeText');
    notice.style.display = 'flex';
    noticeText.textContent = serverSeasonId
      ? `Új szezon érzékelve (ID: ${serverSeasonId}) – az AI az új adatok alapján elemez`
      : 'Szezonváltás érzékelve – az AI az új adatok alapján elemez';
    // AI cache törlése: következő generálásnál friss lesz
    document.getElementById('aiTable').innerHTML =
      '<div style="padding:32px; text-align:center; color:var(--text-muted); font-size:.72rem; font-family:\'DM Mono\',monospace">Új szezon! Kattints a "Generálás" gombra az AI elemzéshez.</div>';
    document.getElementById('aiPanel').style.display = 'none';
  }

  lastTotalPoints = totalPoints;
  if (serverSeasonId) lastSeasonId = serverSeasonId;
}

// ── Valódi tabella ───────────────────────────────────────────
async function fetchRealStandings() {
  const res = await fetch('/api/standings?liga=pl');
  if (!res.ok) throw new Error(`API hiba: ${res.status}`);
  const data = await res.json();
  return { standings: data.standings || [], seasonId: data.seasonId || null };
}

function renderRealTable(standings) {
  const table = document.getElementById('realTable');
  const meta  = document.getElementById('realMeta');
  const time  = document.getElementById('realUpdateTime');
  if (!standings || standings.length === 0) {
    table.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted); font-size:.72rem">Nincs adat</div>';
    return;
  }
  const total = standings.length;
  table.innerHTML = standings.map((r, i) => `
    <div class="${rowClass(r.pos, total)}" style="animation-delay:${i * 0.025}s">
      <span class="col-pos">${r.pos}</span>
      <span class="col-trend">${trendHtml(r.trend ?? 'same')}</span>
      <span class="col-team">${logoHtml(r.logo)}<span class="team-name">${r.team}</span></span>
      <span class="col-goals">${r.goalsFor ?? '–'}:${r.goalsAgainst ?? '–'}</span>
      <span class="col-gd">${gd(r.goalsFor, r.goalsAgainst)}</span>
      <span class="col-pts">${r.pts}</span>
    </div>
  `).join('');
  meta.className = 'lb-meta';
  meta.querySelector('span:first-child').innerHTML = '<span class="refresh-dot"></span>Élő adat';
  time.textContent = new Date().toLocaleTimeString('hu-HU');
}

async function loadRealTable() {
  const meta = document.getElementById('realMeta');
  meta.className = 'lb-meta loading';
  meta.querySelector('span:first-child').innerHTML = '<span class="refresh-dot"></span>Betöltés...';
  try {
    const { standings, seasonId } = await fetchRealStandings();
    detectSeasonReset(standings, seasonId);
    realStandings = standings;
    renderRealTable(standings);
  } catch(e) {
    showError(e.message);
    meta.className = 'lb-meta error';
    meta.querySelector('span:first-child').innerHTML = '<span class="refresh-dot"></span>Hiba';
  }
}

// ── AI tabella generálás ──────────────────────────────────────
async function generateAITable() {
  const meta    = document.getElementById('aiMeta');
  const aiTable = document.getElementById('aiTable');
  const aiPanel = document.getElementById('aiPanel');
  const time    = document.getElementById('aiUpdateTime');

  meta.className = 'lb-meta loading';
  meta.querySelector('span:first-child').innerHTML = '<span class="refresh-dot"></span>AI generálás...';
  aiTable.innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
  aiPanel.style.display = 'none';
  hideError();

  if (realStandings.length === 0) {
    try {
      const { standings, seasonId } = await fetchRealStandings();
      detectSeasonReset(standings, seasonId);
      realStandings = standings;
    } catch(e) {
      showError(`Nem sikerült betölteni a valódi adatokat: ${e.message}`);
      meta.className = 'lb-meta error';
      return;
    }
  }

  const allTeamsData = realStandings.map(t =>
    `${t.pos}. ${t.team}: ${t.pts}pt, ${t.goalsFor||0}:${t.goalsAgainst||0}`
  ).join('\n');

  const totalPts = realStandings.reduce((s, t) => s + (t.pts || 0), 0);
  const seasonNote = totalPts < 50
    ? 'FONTOS: Ez egy ÚJ szezon eleje, nagyon kevés meccset játszottak. Becsüld meg a teljes szezon végét!'
    : 'Becsüld meg a szezon végét a mostani teljesítmény alapján!';

  const prompt = `Te egy virtuális futball liga profi elemzője vagy. A jelenlegi tabella alapján készíts SAJÁT, FÜGGETLEN előrejelzést a szezon végére!

JELENLEGI TABELLA:
${allTeamsData}

${seasonNote}

SZABÁLYOK – KÖTELEZŐ BETARTANI:
1. A sorrend VÁLTOZZON JELENTŐSEN – legalább 5 csapat kerüljön más helyre mint jelenleg!
2. A pontok és gólok KÜLÖNBÖZZENEK – add hozzá a becsült hátralévő meccsek pontjait!
3. Egy jelenlegi középcsapat kerüljön fel, egy top csapat essen vissza!
4. trend: "up" ha feljebb kerül a jelenleginél, "down" ha lejjebb, "same" ha nagyjából marad
5. TILOS a valós tabella egyszerű lemásolása!

Válaszolj KIZÁRÓLAG kompakt JSON tömbbel (egy sorban), semmi más szöveg:
[{"pos":1,"team":"CsapatNév","goalsFor":72,"goalsAgainst":28,"pts":87,"trend":"up"},{"pos":2,...}]`;

  try {
    const text = await callAI(prompt);
    console.log('LLM7 nyers válasz:', text);

    const aiStandings = extractJSONArray(text);
    if (!aiStandings || aiStandings.length === 0) throw new Error('Üres tabella érkezett');

    renderAITable(aiStandings);
    await generateAnalysis(aiStandings);

    meta.className = 'lb-meta';
    meta.querySelector('span:first-child').innerHTML = '<span class="refresh-dot"></span>AI becslés';
    time.textContent = new Date().toLocaleTimeString('hu-HU');

  } catch(e) {
    console.error('Generálási hiba:', e);
    showError(e.message);
    meta.className = 'lb-meta error';
    meta.querySelector('span:first-child').innerHTML = '<span class="refresh-dot"></span>Hiba';
    aiTable.innerHTML = '<div style="padding:32px; text-align:center; color:var(--text-muted); font-size:.72rem; font-family:\'DM Mono\',monospace">Hiba. Próbáld újra.</div>';
  }
}

function renderAITable(standings) {
  const table = document.getElementById('aiTable');
  if (!standings || standings.length === 0) {
    table.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">Nincs adat</div>';
    return;
  }
  const total = standings.length;
  table.innerHTML = standings.map((r, i) => `
    <div class="${rowClass(r.pos, total)}" style="animation-delay:${i * 0.025}s">
      <span class="col-pos">${r.pos}</span>
      <span class="col-trend">${trendHtml(r.trend)}</span>
      <span class="col-team">
        <span class="team-logo-placeholder"></span>
        <span class="team-name">${r.team}</span>
      </span>
      <span class="col-goals">${r.goalsFor}:${r.goalsAgainst}</span>
      <span class="col-gd">${gd(r.goalsFor, r.goalsAgainst)}</span>
      <span class="col-pts">${r.pts}</span>
    </div>
  `).join('');
}

async function generateAnalysis(standings) {
  const aiPanel = document.getElementById('aiPanel');
  const aiBody  = document.getElementById('aiBody');
  const top3 = standings.slice(0, 3).map(t => `${t.pos}. ${t.team} (${t.pts} pont)`).join(', ');
  const bot3 = standings.slice(-3).map(t => `${t.pos}. ${t.team} (${t.pts} pont)`).join(', ');

  const prompt = `Rövid elemzés MAGYARUL (max 4 mondat):
Top 3: ${top3}
Utolsó 3: ${bot3}
Miért lehetnek ezek a csapatok ilyen helyzetben a következő körökben?`;

  try {
    const text = await callAI(prompt);
    if (text) {
      aiBody.innerHTML = text.replace(/\n/g, '<br>');
      aiPanel.style.display = 'block';
    }
  } catch(e) {
    aiPanel.style.display = 'none';
  }
}

// ── Hibakezelés ───────────────────────────────────────────────
function showError(msg) {
  const box = document.getElementById('errorBox');
  document.getElementById('errorText').textContent = msg;
  box.classList.add('show');
}
function hideError() {
  document.getElementById('errorBox').classList.remove('show');
}

// ── Tab váltás ────────────────────────────────────────────────
function showRealTable() {
  document.getElementById('realTableContainer').style.display = 'block';
  document.getElementById('aiTableContainer').style.display = 'none';
  document.getElementById('realTab').classList.add('active');
  document.getElementById('aiTab').classList.remove('active');
}
function showAITable() {
  document.getElementById('realTableContainer').style.display = 'none';
  document.getElementById('aiTableContainer').style.display = 'block';
  document.getElementById('realTab').classList.remove('active');
  document.getElementById('aiTab').classList.add('active');
}

// ── Init ──────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  loadRealTable();
  document.getElementById('refreshRealBtn').addEventListener('click', loadRealTable);
  document.getElementById('generateAIBtn').addEventListener('click', generateAITable);
  setInterval(loadRealTable, 30000);
});
</script>
</body>
</html>
