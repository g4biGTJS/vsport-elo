<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VSPORT ‚Äì AI Tabella</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#030507;--surface:#070c10;--surface2:#0b1218;--surface3:#0f1820;
      --border:#0e1e28;--border2:#162535;
      --text:#d4e8f0;--text-dim:#4a7a99;--text-muted:#1e3d52;
      --green:#00e676;--green2:#00c853;--red:#ff3d3d;--amber:#ffab00;--cyan:#00b8d4;
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
    html,body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;overflow-x:hidden;}

    .bg-layer{position:fixed;inset:0;z-index:0;pointer-events:none;}
    .bg-mesh{background:radial-gradient(ellipse 80% 60% at 20% 30%,rgba(0,80,40,0.18) 0%,transparent 60%),radial-gradient(ellipse 60% 80% at 80% 70%,rgba(0,40,80,0.2) 0%,transparent 60%),radial-gradient(ellipse 100% 40% at 50% 100%,rgba(0,100,60,0.12) 0%,transparent 50%),#030507;animation:meshShift 12s ease-in-out infinite alternate;}
    @keyframes meshShift{0%{background-position:0% 0%,100% 100%,50% 100%}50%{background-position:10% 20%,80% 80%,60% 90%}100%{background-position:20% 5%,70% 90%,50% 80%}}
    .bg-orbs{overflow:hidden;}
    .orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:1;animation:orbFloat linear infinite;}
    .orb1{width:500px;height:500px;background:radial-gradient(circle,rgba(0,180,80,0.12) 0%,transparent 70%);top:-100px;left:-100px;animation-duration:25s;}
    .orb2{width:400px;height:400px;background:radial-gradient(circle,rgba(0,100,200,0.1) 0%,transparent 70%);top:30%;right:-80px;animation-duration:30s;animation-delay:-8s;}
    .orb3{width:350px;height:350px;background:radial-gradient(circle,rgba(0,220,100,0.08) 0%,transparent 70%);bottom:10%;left:30%;animation-duration:20s;animation-delay:-15s;}
    @keyframes orbFloat{0%{transform:translate(0,0) scale(1)}25%{transform:translate(40px,-30px) scale(1.1)}50%{transform:translate(-20px,50px) scale(0.95)}75%{transform:translate(30px,20px) scale(1.05)}100%{transform:translate(0,0) scale(1)}}
    .bg-grid{background-image:linear-gradient(rgba(0,180,100,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,180,100,0.025) 1px,transparent 1px);background-size:60px 60px;animation:gridSlide 20s linear infinite;}
    @keyframes gridSlide{0%{background-position:0 0}100%{background-position:60px 60px}}
    .bg-scan{background:linear-gradient(to bottom,transparent 49.9%,rgba(0,230,118,0.03) 50%,transparent 50.1%);background-size:100% 8px;animation:scanMove 3s linear infinite;}
    @keyframes scanMove{0%{background-position:0 0}100%{background-position:0 8px}}
    .bg-noise{opacity:.035;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");background-size:256px;animation:grainAnim .4s steps(1) infinite;}
    @keyframes grainAnim{0%{transform:translate(0,0)}10%{transform:translate(-3%,-2%)}20%{transform:translate(3%,2%)}30%{transform:translate(-2%,3%)}40%{transform:translate(2%,-3%)}50%{transform:translate(-3%,2%)}60%{transform:translate(3%,-2%)}70%{transform:translate(-2%,-3%)}80%{transform:translate(2%,3%)}90%{transform:translate(-3%,3%)}100%{transform:translate(3%,-1%)}}
    .bg-vignette{background:radial-gradient(ellipse 100% 100% at 50% 50%,transparent 40%,rgba(0,0,0,0.7) 100%);}
    #particleCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.5;}

    header{position:sticky;top:0;z-index:100;background:rgba(3,5,7,0.88);backdrop-filter:blur(20px) saturate(180%);border-bottom:1px solid rgba(0,230,118,0.1);padding:0 28px;height:58px;display:flex;align-items:center;gap:16px;box-shadow:0 4px 32px rgba(0,0,0,0.6);}
    header::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent 0%,rgba(0,230,118,0.4) 30%,rgba(0,230,118,0.8) 50%,rgba(0,230,118,0.4) 70%,transparent 100%);background-size:200% 100%;animation:lineSlide 4s linear infinite;}
    @keyframes lineSlide{0%{background-position:200% 0}100%{background-position:-200% 0}}

    .header-left{display:flex;align-items:center;gap:14px;animation:slideL .7s cubic-bezier(.16,1,.3,1) both;}
    .header-right{margin-left:auto;animation:slideR .7s cubic-bezier(.16,1,.3,1) .1s both;}
    @keyframes slideL{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
    @keyframes slideR{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}

    .live-pulse-wrap{position:relative;display:flex;align-items:center;justify-content:center;width:28px;height:28px;}
    .live-pulse-ring{position:absolute;width:28px;height:28px;border-radius:50%;border:1px solid rgba(0,230,118,0.4);animation:ringPulse 2s ease-out infinite;}
    .live-pulse-ring:nth-child(2){animation-delay:.5s;}
    @keyframes ringPulse{0%{transform:scale(.5);opacity:1}100%{transform:scale(1.4);opacity:0}}
    .live-dot-core{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 12px var(--green),0 0 24px rgba(0,230,118,0.4);position:relative;z-index:1;animation:corePulse 2s ease-in-out infinite;}
    @keyframes corePulse{0%,100%{box-shadow:0 0 8px var(--green),0 0 16px rgba(0,230,118,0.3)}50%{box-shadow:0 0 16px var(--green),0 0 32px rgba(0,230,118,0.6)}}

    .site-title{font-family:'Barlow Condensed',sans-serif;font-size:1.8rem;font-weight:900;letter-spacing:6px;color:#fff;text-transform:uppercase;text-shadow:0 0 30px rgba(255,255,255,0.2);position:relative;}
    .site-title::before,.site-title::after{content:'VSPORT';position:absolute;left:0;top:0;opacity:0;}
    .site-title::before{color:var(--green);animation:g1 8s infinite;clip-path:polygon(0 30%,100% 30%,100% 50%,0 50%);}
    .site-title::after{color:var(--cyan);animation:g2 8s infinite;clip-path:polygon(0 60%,100% 60%,100% 80%,0 80%);}
    @keyframes g1{0%,92%,100%{opacity:0;transform:none}93%{opacity:.7;transform:translate(-2px,0)}94%{opacity:0}96%{opacity:.5;transform:translate(2px,0)}97%{opacity:0}}
    @keyframes g2{0%,93%,100%{opacity:0;transform:none}94%{opacity:.5;transform:translate(2px,1px)}95%{opacity:0}97%{opacity:.4;transform:translate(-2px,0)}98%{opacity:0}}

    .header-sep{width:1px;height:24px;background:linear-gradient(to bottom,transparent,var(--border2),transparent);}

    .back-btn{display:flex;align-items:center;gap:8px;color:var(--text-dim);font-family:'JetBrains Mono',monospace;font-size:.58rem;text-decoration:none;letter-spacing:1.5px;padding:6px 14px;border:1px solid rgba(0,230,118,0.15);border-radius:2px;transition:all .25s;background:rgba(0,230,118,0.04);}
    .back-btn:hover{color:var(--green);border-color:rgba(0,230,118,0.4);box-shadow:0 0 16px rgba(0,230,118,0.1);}

    .ai-header-badge{display:flex;align-items:center;gap:8px;background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.2);border-radius:2px;padding:5px 14px;font-family:'JetBrains Mono',monospace;font-size:.58rem;letter-spacing:2px;color:var(--green);box-shadow:0 0 16px rgba(0,230,118,0.08);}
    .ai-badge-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:corePulse 1.5s infinite;}

    .page{position:relative;z-index:1;max-width:960px;margin:0 auto;padding:32px 20px 80px;animation:pageUp .6s cubic-bezier(.16,1,.3,1) .1s both;}
    @keyframes pageUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    .tabs{display:flex;margin-bottom:28px;border-bottom:1px solid rgba(0,230,118,0.08);gap:4px;}
    .tab{background:none;border:none;border-bottom:2px solid transparent;color:var(--text-dim);font-family:'JetBrains Mono',monospace;font-size:.6rem;letter-spacing:2px;padding:10px 22px;cursor:pointer;transition:all .2s;text-transform:uppercase;display:flex;align-items:center;gap:8px;position:relative;top:1px;}
    .tab:hover{color:rgba(0,230,118,0.7);}
    .tab.active{color:var(--green);border-bottom-color:var(--green);text-shadow:0 0 12px rgba(0,230,118,0.4);}
    .tab-icon{width:14px;height:14px;}

    .section-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .section-title{font-family:'Barlow Condensed',sans-serif;font-size:1.4rem;font-weight:800;letter-spacing:4px;color:var(--text);display:flex;align-items:center;gap:12px;text-transform:uppercase;}
    .section-title-icon{width:18px;height:18px;opacity:.9;}

    .ai-badge-pill{background:rgba(0,230,118,0.1);border:1px solid rgba(0,230,118,0.25);color:var(--green);font-size:.52rem;font-family:'JetBrains Mono',monospace;padding:3px 10px;border-radius:2px;letter-spacing:1.5px;box-shadow:0 0 12px rgba(0,230,118,0.1);animation:corePulse 2s infinite;}

    .btn{display:flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--surface2),var(--surface3));border:1px solid var(--border2);color:var(--text-dim);font-size:.6rem;font-family:'JetBrains Mono',monospace;letter-spacing:1.5px;padding:8px 16px;border-radius:2px;cursor:pointer;transition:all .2s;text-transform:uppercase;}
    .btn:hover{background:rgba(0,230,118,0.06);border-color:rgba(0,230,118,0.3);color:var(--green);box-shadow:0 0 20px rgba(0,230,118,0.1);}
    .btn-icon{width:13px;height:13px;}

    .season-notice{display:flex;align-items:center;gap:10px;background:rgba(255,171,0,0.06);border:1px solid rgba(255,171,0,0.2);border-radius:2px;padding:10px 14px;margin-bottom:16px;font-size:.68rem;color:var(--amber);font-family:'JetBrains Mono',monospace;}

    .leaderboard-block{background:var(--surface);border:1px solid var(--border);border-radius:3px;overflow:hidden;margin-bottom:16px;position:relative;}
    .leaderboard-block::before{content:'';position:absolute;top:0;left:0;width:40px;height:40px;border-top:2px solid rgba(0,230,118,0.2);border-left:2px solid rgba(0,230,118,0.2);pointer-events:none;z-index:2;}

    .leaderboard-header-bar{background:linear-gradient(90deg,rgba(0,50,25,0.9) 0%,rgba(0,80,40,0.6) 50%,rgba(0,50,25,0.3) 100%);display:grid;grid-template-columns:28px 18px 1fr 80px 46px 38px;align-items:center;padding:8px 12px;gap:4px;border-bottom:1px solid rgba(0,230,118,0.12);position:relative;}
    .leaderboard-header-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,230,118,0.4),transparent);}
    .leaderboard-header-bar span{font-family:'JetBrains Mono',monospace;font-size:.52rem;font-weight:700;color:rgba(0,230,118,0.65);text-transform:uppercase;letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .leaderboard-header-bar .h-right{text-align:right;}

    .lb-meta{background:rgba(0,0,0,0.4);border-bottom:1px solid var(--border);padding:4px 12px;font-size:.56rem;color:var(--text-muted);display:flex;justify-content:space-between;align-items:center;font-family:'JetBrains Mono',monospace;}
    .refresh-dot{width:5px;height:5px;border-radius:50%;background:var(--green);display:inline-block;margin-right:5px;animation:corePulse 2s infinite;}
    .lb-meta.loading .refresh-dot{background:var(--amber);box-shadow:0 0 6px rgba(255,171,0,0.4);}
    .lb-meta.error .refresh-dot{background:var(--red);}

    .leaderboard-body{background:var(--surface);}

    .lb-row{display:grid;grid-template-columns:28px 18px 1fr 80px 46px 38px;align-items:center;padding:5px 12px;gap:4px;border-bottom:1px solid var(--border);transition:background .15s,transform .15s;animation:rowSlide .4s ease both;position:relative;}
    .lb-row:last-child{border-bottom:none;}
    .lb-row::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;opacity:0;transition:opacity .15s;}
    .lb-row:hover::before{opacity:1;}
    .lb-row:hover{background:var(--surface2);transform:translateX(2px);}
    @keyframes rowSlide{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}

    .lb-row.top3{background:linear-gradient(90deg,rgba(0,100,45,0.15) 0%,transparent 100%);}
    .lb-row.top3::before{background:var(--green);}
    .lb-row.top3:hover{background:rgba(0,100,45,0.2);}
    .lb-row.relegation{background:linear-gradient(90deg,rgba(255,61,61,0.07) 0%,transparent 100%);}
    .lb-row.relegation::before{background:var(--red);}
    .lb-row.relegation:hover{background:rgba(255,61,61,0.1);}

    .col-pos{font-family:'JetBrains Mono',monospace;font-size:.68rem;font-weight:700;color:var(--text-dim);text-align:center;}
    .lb-row.top3 .col-pos{color:var(--green);text-shadow:0 0 8px rgba(0,230,118,0.4);}
    .lb-row.relegation .col-pos{color:var(--red);}
    .col-trend{display:flex;align-items:center;justify-content:center;}
    .trend-up{color:var(--green);font-size:.5rem;filter:drop-shadow(0 0 4px rgba(0,230,118,0.6));}
    .trend-down{color:var(--red);font-size:.5rem;filter:drop-shadow(0 0 4px rgba(255,61,61,0.6));}
    .trend-same{color:#1a2e3d;font-size:.5rem;}
    .col-team{display:flex;align-items:center;gap:7px;min-width:0;}
    .team-logo{width:16px;height:16px;object-fit:contain;flex-shrink:0;}
    .team-logo-placeholder{width:16px;height:16px;flex-shrink:0;}
    .team-name{font-size:.74rem;font-weight:600;color:#aac5d4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .lb-row.top3 .team-name{color:var(--text);}
    .col-goals{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--text-dim);text-align:right;}
    .col-gd{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--text-muted);text-align:right;}
    .col-pts{font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;color:#fff;text-align:right;text-shadow:0 0 12px rgba(255,255,255,0.15);}
    .lb-row.top3 .col-pts{color:var(--green);text-shadow:0 0 12px rgba(0,230,118,0.4);}

    .aipanel{background:var(--surface);border:1px solid rgba(0,230,118,0.1);border-radius:3px;overflow:hidden;margin-top:16px;animation:rowSlide .5s ease both;position:relative;}
    .aipanel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,230,118,0.5),transparent);}
    .aipanel-hdr{background:linear-gradient(90deg,rgba(0,50,25,0.7),rgba(0,20,10,0.5));border-bottom:1px solid rgba(0,230,118,0.08);padding:10px 16px;display:flex;align-items:center;gap:10px;}
    .aipanel-title{font-family:'Barlow Condensed',sans-serif;font-size:.9rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--text);}
    .aibody{padding:18px 20px;font-size:.84rem;line-height:1.9;color:var(--text-dim);min-height:80px;}

    .dots{display:flex;gap:6px;padding:20px 0;justify-content:center;}
    .dots span{width:6px;height:6px;border-radius:50%;background:var(--green);opacity:.15;animation:dotPulse 1.2s infinite;}
    .dots span:nth-child(2){animation-delay:.2s;}.dots span:nth-child(3){animation-delay:.4s;}
    @keyframes dotPulse{0%,100%{opacity:.15}50%{opacity:.9;box-shadow:0 0 8px var(--green)}}

    .error-box{display:none;background:rgba(255,61,61,0.06);border:1px solid rgba(255,61,61,0.2);border-radius:2px;padding:12px 16px;font-size:.72rem;color:#ff8a80;margin-bottom:16px;font-family:'JetBrains Mono',monospace;}
    .error-box.show{display:flex;align-items:center;gap:8px;}

    .footer-line{position:fixed;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent 0%,rgba(0,230,118,0.2) 20%,rgba(0,230,118,0.6) 50%,rgba(0,230,118,0.2) 80%,transparent 100%);z-index:50;}

    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* ‚ïê‚ïê‚ïê CUSTOM DROPDOWN ‚ïê‚ïê‚ïê */
    .custom-select-wrap{position:relative;flex:1;z-index:1;}
    .custom-select-wrap.open{z-index:500;}
    .custom-select-wrap.open .custom-select-trigger{border-color:rgba(0,230,118,0.5);box-shadow:0 0 20px rgba(0,230,118,0.1);}
    .custom-select-wrap.open .cs-arrow{transform:rotate(180deg);color:var(--green);}
    .custom-select-trigger{display:flex;align-items:center;gap:10px;width:100%;background:var(--surface2);border:1px solid var(--border2);color:var(--text);font-family:'Barlow',sans-serif;font-size:.82rem;font-weight:600;padding:11px 14px;border-radius:3px;cursor:pointer;transition:all .2s;user-select:none;position:relative;}
    .custom-select-trigger:hover{border-color:rgba(0,230,118,0.3);background:rgba(0,230,118,0.03);}
    .cs-team-dot{width:8px;height:8px;border-radius:50%;background:var(--text-muted);flex-shrink:0;transition:all .2s;}
    .cs-val{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .cs-val.placeholder{color:var(--text-muted);font-weight:400;font-size:.75rem;}
    .cs-arrow{margin-left:auto;color:var(--text-muted);transition:transform .2s,color .2s;flex-shrink:0;}
    .cs-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--surface2);border:1px solid rgba(0,230,118,0.25);border-radius:3px;z-index:9999;box-shadow:0 8px 40px rgba(0,0,0,0.9),0 0 0 1px rgba(0,230,118,0.08);max-height:220px;overflow-y:auto;display:none;animation:dropIn .15s ease both;}
    .cs-dropdown::-webkit-scrollbar{width:4px;}.cs-dropdown::-webkit-scrollbar-track{background:transparent;}.cs-dropdown::-webkit-scrollbar-thumb{background:rgba(0,230,118,0.2);border-radius:2px;}
    .custom-select-wrap.open .cs-dropdown{display:block;}
    @keyframes dropIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
    .cs-search{display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid var(--border);background:rgba(0,0,0,0.3);}
    .cs-search-input{background:none;border:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.65rem;outline:none;flex:1;letter-spacing:.5px;}
    .cs-search-input::placeholder{color:var(--text-muted);}
    .cs-option{display:flex;align-items:center;gap:10px;padding:9px 14px;cursor:pointer;transition:background .1s;font-size:.8rem;font-family:'Barlow',sans-serif;font-weight:500;color:#aac5d4;border-bottom:1px solid rgba(255,255,255,0.02);}
    .cs-option:last-child{border-bottom:none;}
    .cs-option:hover,.cs-option.focused{background:rgba(0,230,118,0.07);color:var(--text);}
    .cs-option.selected{color:var(--green);background:rgba(0,230,118,0.05);}
    .cs-option.selected .cs-opt-dot{background:var(--green);box-shadow:0 0 6px rgba(0,230,118,0.5);}
    .cs-opt-dot{width:7px;height:7px;border-radius:50%;background:var(--text-muted);flex-shrink:0;}
    .cs-opt-pos{font-family:'JetBrains Mono',monospace;font-size:.55rem;color:var(--text-muted);margin-left:auto;min-width:30px;text-align:right;}
    .cs-option.top3-opt .cs-opt-dot{background:var(--green);}
    .cs-option.rel-opt .cs-opt-dot{background:var(--red);}
    .cs-option.top3-opt .cs-opt-pos{color:var(--green);}
    .cs-option.rel-opt .cs-opt-pos{color:var(--red);}

    /* ‚ïê‚ïê‚ïê TIPP GENERATOR ‚ïê‚ïê‚ïê */
    .tip-section{margin-top:32px;position:relative;}
    .tip-section-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .tip-section-title{font-family:'Barlow Condensed',sans-serif;font-size:1.4rem;font-weight:800;letter-spacing:4px;color:var(--text);text-transform:uppercase;display:flex;align-items:center;gap:12px;}
    .tip-badge{background:rgba(255,171,0,0.1);border:1px solid rgba(255,171,0,0.3);color:var(--amber);font-size:.52rem;font-family:'JetBrains Mono',monospace;padding:3px 10px;border-radius:2px;letter-spacing:1.5px;animation:corePulse 2s infinite;}

    .tip-matches-list{display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
    .tip-match-row{display:flex;align-items:center;gap:10px;background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:12px 14px;position:relative;transition:border-color .2s;animation:rowSlide .3s ease both;overflow:visible;}
    .tip-match-row:hover{border-color:var(--border2);}
    .tip-match-num{font-family:'JetBrains Mono',monospace;font-size:.55rem;color:var(--text-muted);letter-spacing:1px;flex-shrink:0;min-width:22px;}
    .tip-label{font-family:'JetBrains Mono',monospace;font-size:.52rem;letter-spacing:2px;color:var(--text-muted);text-transform:uppercase;display:block;margin-bottom:5px;}
    .tip-team-wrap{flex:1;display:flex;flex-direction:column;min-width:0;}

    .tip-swap-wrap{display:flex;flex-direction:column;align-items:center;gap:4px;flex-shrink:0;}
    .tip-swap-btn{width:38px;height:38px;background:linear-gradient(135deg,rgba(0,230,118,0.08),rgba(0,100,200,0.08));border:1px solid rgba(0,230,118,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;position:relative;overflow:hidden;}
    .tip-swap-btn::before{content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle,rgba(0,230,118,0.12),transparent);opacity:0;transition:opacity .2s;}
    .tip-swap-btn:hover::before{opacity:1;}
    .tip-swap-btn:hover{border-color:rgba(0,230,118,0.5);box-shadow:0 0 20px rgba(0,230,118,0.15);transform:scale(1.08);}
    .tip-swap-btn svg{transition:transform .4s cubic-bezier(.34,1.56,.64,1);}
    .tip-swap-btn.spinning svg{transform:rotate(180deg);}

    .tip-remove-btn{width:30px;height:30px;background:rgba(255,61,61,0.05);border:1px solid rgba(255,61,61,0.15);border-radius:2px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;flex-shrink:0;color:var(--red);opacity:.5;}
    .tip-remove-btn:hover{opacity:1;background:rgba(255,61,61,0.1);border-color:rgba(255,61,61,0.4);}

    .tip-add-row{display:flex;gap:10px;margin-bottom:20px;}
    .tip-add-btn{display:flex;align-items:center;gap:8px;background:rgba(0,230,118,0.04);border:1px dashed rgba(0,230,118,0.2);color:rgba(0,230,118,0.5);font-family:'JetBrains Mono',monospace;font-size:.6rem;letter-spacing:2px;padding:10px 18px;border-radius:3px;cursor:pointer;transition:all .2s;text-transform:uppercase;}
    .tip-add-btn:hover{background:rgba(0,230,118,0.08);border-color:rgba(0,230,118,0.4);color:var(--green);}

    .tip-gen-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:13px 0;background:linear-gradient(135deg,rgba(0,80,40,0.5),rgba(0,50,25,0.8));border:1px solid rgba(0,230,118,0.3);color:var(--green);font-family:'JetBrains Mono',monospace;font-size:.65rem;letter-spacing:2.5px;text-transform:uppercase;cursor:pointer;border-radius:3px;transition:all .25s;margin-bottom:20px;position:relative;overflow:hidden;}
    .tip-gen-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(0,230,118,0.06),transparent);transform:translateX(-100%);transition:transform .4s;}
    .tip-gen-btn:hover::after{transform:translateX(100%);}
    .tip-gen-btn:hover{border-color:rgba(0,230,118,0.6);box-shadow:0 0 32px rgba(0,230,118,0.15);background:linear-gradient(135deg,rgba(0,100,50,0.5),rgba(0,60,30,0.8));}
    .tip-gen-btn:disabled{opacity:.4;cursor:not-allowed;}
    .tip-gen-btn svg{width:15px;height:15px;}

    /* result */
    .tip-results-list{display:flex;flex-direction:column;gap:14px;}
    .tip-result-block{background:var(--surface);border:1px solid rgba(0,230,118,0.12);border-radius:3px;overflow:hidden;position:relative;}
    .tip-result-block::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,230,118,0.6),transparent);}
    .tip-result-hdr{background:linear-gradient(90deg,rgba(0,50,25,0.8),rgba(0,20,10,0.5));border-bottom:1px solid rgba(0,230,118,0.08);padding:10px 16px;display:flex;align-items:center;gap:10px;}
    .tip-vs-label{font-family:'Barlow Condensed',sans-serif;font-size:1rem;font-weight:800;letter-spacing:2px;color:var(--text);text-transform:uppercase;display:flex;align-items:center;gap:8px;flex:1;flex-wrap:wrap;}
    .tip-vs-sep{color:rgba(0,230,118,0.5);font-size:.9rem;}
    .tip-match-idx{font-family:'JetBrains Mono',monospace;font-size:.52rem;color:var(--text-muted);background:rgba(0,0,0,0.3);border:1px solid var(--border);padding:2px 7px;border-radius:2px;}

    .tip-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;padding:14px;}
    .tip-card{background:var(--surface2);border:1px solid var(--border2);border-radius:3px;padding:13px 12px;text-align:center;transition:all .25s;position:relative;overflow:hidden;animation:rowSlide .4s ease both;}
    .tip-card.highlighted{border-color:rgba(0,230,118,0.5);background:rgba(0,50,25,0.4);box-shadow:0 0 24px rgba(0,230,118,0.1);}
    .tip-card.highlighted::after{content:'‚òÖ TOP';position:absolute;top:5px;right:5px;font-family:'JetBrains Mono',monospace;font-size:.38rem;letter-spacing:1px;color:var(--green);background:rgba(0,230,118,0.1);border:1px solid rgba(0,230,118,0.25);padding:2px 5px;border-radius:2px;}
    .tip-card-name{font-family:'JetBrains Mono',monospace;font-size:.55rem;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;margin-bottom:7px;line-height:1.4;}
    .tip-card-val{font-family:'Barlow Condensed',sans-serif;font-size:1.5rem;font-weight:800;color:var(--text);letter-spacing:2px;}
    .tip-card.highlighted .tip-card-val{color:var(--green);text-shadow:0 0 16px rgba(0,230,118,0.4);}
    .tip-card-conf-bar{height:3px;background:var(--border);border-radius:2px;margin-top:8px;overflow:hidden;}
    .tip-card-conf-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--text-muted),var(--cyan));transition:width .8s cubic-bezier(.16,1,.3,1);}
    .tip-card.highlighted .tip-card-conf-fill{background:linear-gradient(90deg,var(--green2),var(--green));}
    .tip-card-conf{font-size:.53rem;color:var(--text-muted);margin-top:4px;font-family:'JetBrains Mono',monospace;}
    .tip-card.highlighted .tip-card-conf{color:rgba(0,230,118,0.7);}
    .tip-card-stat{font-size:.5rem;color:var(--text-muted);margin-top:3px;font-family:'JetBrains Mono',monospace;opacity:.7;}

    /* ‚ïê‚ïê‚ïê xG BANNER ‚ïê‚ïê‚ïê */
    .tip-xg-banner{display:flex;align-items:stretch;gap:0;border-bottom:1px solid var(--border);background:linear-gradient(135deg,rgba(0,40,20,0.6),rgba(0,20,40,0.4));}
    .tip-xg-side{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px 12px;gap:2px;}
    .tip-xg-right{background:rgba(0,20,40,0.2);}
    .tip-xg-team{font-family:'Barlow Condensed',sans-serif;font-size:.85rem;font-weight:700;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;text-align:center;}
    .tip-xg-val{font-family:'Barlow Condensed',sans-serif;font-size:2.4rem;font-weight:900;color:var(--green);text-shadow:0 0 20px rgba(0,230,118,0.3);line-height:1;}
    .tip-xg-label{font-family:'JetBrains Mono',monospace;font-size:.48rem;letter-spacing:3px;color:rgba(0,230,118,0.5);text-transform:uppercase;}
    .tip-xg-sub{font-family:'JetBrains Mono',monospace;font-size:.5rem;color:var(--text-muted);margin-top:3px;}
    .tip-xg-center{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 16px;position:relative;}
    .tip-xg-divider{width:1px;background:linear-gradient(to bottom,transparent,rgba(0,230,118,0.2),transparent);position:absolute;top:0;bottom:0;}
    .tip-xg-total-wrap{display:flex;flex-direction:column;align-items:center;gap:2px;background:rgba(0,0,0,0.4);border:1px solid rgba(0,230,118,0.15);border-radius:3px;padding:8px 14px;position:relative;z-index:1;}
    .tip-xg-total-val{font-family:'Barlow Condensed',sans-serif;font-size:1.5rem;font-weight:900;color:var(--amber);text-shadow:0 0 12px rgba(255,171,0,0.3);}
    .tip-xg-total-lbl{font-family:'JetBrains Mono',monospace;font-size:.42rem;letter-spacing:2px;color:var(--text-muted);text-transform:uppercase;}

    /* ‚ïê‚ïê‚ïê TIP CARD v2 ‚ïê‚ïê‚ïê */
    .tip-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:12px;}
    @media(max-width:600px){.tip-cards{grid-template-columns:repeat(2,1fr);}}
    .tip-card2{background:var(--surface2);border:1px solid var(--border2);border-radius:3px;padding:12px 10px 10px;text-align:center;position:relative;overflow:hidden;animation:rowSlide .4s ease both;transition:border-color .2s,background .2s;}
    .tip-card2.highlighted{border-color:rgba(0,230,118,0.4);background:rgba(0,40,20,0.5);box-shadow:0 0 20px rgba(0,230,118,0.08);}
    .tip-card2-best-badge{position:absolute;top:0;left:0;right:0;background:linear-gradient(90deg,rgba(0,230,118,0.15),rgba(0,230,118,0.05));border-bottom:1px solid rgba(0,230,118,0.15);font-family:'JetBrains Mono',monospace;font-size:.38rem;letter-spacing:1.5px;color:var(--green);padding:3px 0;text-align:center;}
    .tip-card2-code{font-family:'Barlow Condensed',sans-serif;font-size:1.1rem;font-weight:900;letter-spacing:2px;color:var(--text-dim);margin-top:12px;}
    .tip-card2.highlighted .tip-card2-code{color:var(--green);}
    .tip-card2-name{font-family:'JetBrains Mono',monospace;font-size:.48rem;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;margin:4px 0 6px;line-height:1.5;}
    .tip-card2-pick{font-family:'Barlow Condensed',sans-serif;font-size:1.3rem;font-weight:800;letter-spacing:3px;margin-bottom:8px;}
    .tip-card2-ring-wrap{display:flex;justify-content:center;}
    .tip-card2-stat{font-family:'JetBrains Mono',monospace;font-size:.45rem;color:var(--text-muted);margin-top:5px;letter-spacing:.5px;}

    .tip-team-name{color:var(--text);}
    .tip-name-top{color:var(--green);text-shadow:0 0 8px rgba(0,230,118,0.3);}

    .tip-analysis{padding:12px 16px 14px;border-top:1px solid var(--border);}
    .tip-analysis-label{font-family:'JetBrains Mono',monospace;font-size:.5rem;letter-spacing:2px;color:rgba(0,230,118,0.5);text-transform:uppercase;margin-bottom:7px;display:flex;align-items:center;}
    .tip-analysis-text{font-size:.8rem;line-height:1.85;color:var(--text-dim);}
    .tip-stat-row{display:flex;gap:8px;padding:0 14px 14px;flex-wrap:wrap;}
    .tip-stat-chip{background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:2px;padding:4px 10px;font-family:'JetBrains Mono',monospace;font-size:.52rem;color:var(--text-dim);}
    .tip-stat-chip span{color:var(--cyan);}

    /* ‚ïê‚ïê‚ïê HISTORY TAB ‚ïê‚ïê‚ïê */
    .history-info-bar{display:flex;align-items:center;gap:16px;font-family:'JetBrains Mono',monospace;font-size:.55rem;color:var(--text-muted);padding:8px 12px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:2px;margin-bottom:12px;flex-wrap:wrap;}
    .history-header-bar{background:linear-gradient(90deg,rgba(0,50,25,0.9),rgba(0,50,25,0.3));display:grid;grid-template-columns:28px 1fr repeat(4,60px) 50px;align-items:center;padding:8px 12px;gap:4px;border-bottom:1px solid rgba(0,230,118,0.12);}
    .history-header-bar span{font-family:'JetBrains Mono',monospace;font-size:.5rem;font-weight:700;color:rgba(0,230,118,0.65);text-transform:uppercase;letter-spacing:1px;}
    .h-center{text-align:center;}
    .history-delta{font-family:'JetBrains Mono',monospace;font-size:.68rem;font-weight:700;text-align:center;}
    .lb-row{grid-template-columns:28px 18px 1fr 80px 46px 38px;}

    .history-sparklines{margin-top:20px;}
    .history-sparklines-title{font-family:'Barlow Condensed',sans-serif;font-size:1.1rem;font-weight:700;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin-bottom:12px;}
    .sparkline-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;}
    .sparkline-card{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:10px 12px;transition:border-color .2s;}
    .sparkline-card:hover{border-color:rgba(0,230,118,0.3);}
    .sparkline-team{font-family:'Barlow',sans-serif;font-size:.72rem;font-weight:600;color:var(--text-dim);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .sparkline-pts{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--text-muted);margin-top:4px;display:flex;align-items:center;gap:4px;}
  </style>
</head>
<body>

<div class="bg-layer bg-mesh"></div>
<div class="bg-layer bg-orbs"><div class="orb orb1"></div><div class="orb orb2"></div><div class="orb orb3"></div></div>
<div class="bg-layer bg-grid"></div>
<div class="bg-layer bg-scan"></div>
<div class="bg-layer bg-noise"></div>
<div class="bg-layer bg-vignette"></div>
<canvas id="particleCanvas"></canvas>
<div class="footer-line"></div>

<header>
  <div class="header-left">
    <div class="live-pulse-wrap">
      <div class="live-pulse-ring"></div>
      <div class="live-pulse-ring"></div>
      <div class="live-dot-core"></div>
    </div>
    <div class="header-sep"></div>
    <span class="site-title">VSPORT</span>
    <div class="header-sep"></div>
    <a class="back-btn" href="/">
      <svg style="width:11px;height:11px" viewBox="0 0 24 24" fill="none"><path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Vissza
    </a>
  </div>
  <div class="header-right">
    <div class="ai-header-badge">
      <div class="ai-badge-dot"></div>
      AI Elemz≈ë
    </div>
  </div>
</header>

<div class="page">
  <div class="tabs">
    <button class="tab active" id="realTab" onclick="showTab('real')">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none"><path d="M3 3v18h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M7 16l4-4 4 4 4-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Tabella
    </button>
    <button class="tab" id="aiTab" onclick="showTab('ai')">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none"><path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
      AI El≈ërejelz√©s
    </button>
    <button class="tab" id="historyTab" onclick="showTab('history')">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3M3.05 11a9 9 0 1 0 .5-3M3 4v4h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Szezon Napl√≥
    </button>
  </div>

  <!-- TABELLA -->
  <div id="realContainer">
    <div class="section-hdr">
      <div class="section-title">
        <svg class="section-title-icon" viewBox="0 0 24 24" fill="none"><path d="M13 2L4.5 13.5H11L10 22L19.5 10.5H13L13 2Z" fill="currentColor" stroke="currentColor" stroke-width="0.5" stroke-linejoin="round"/></svg>
        Premier Liga
      </div>
      <button class="btn" id="refreshRealBtn">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none"><path d="M1 4v6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Friss√≠t√©s
      </button>
    </div>
    <div class="leaderboard-block">
      <div class="leaderboard-header-bar">
        <span>#</span><span></span><span>Csapat</span>
        <span class="h-right">L≈ëtt‚ÄìKapott</span><span class="h-right">GD</span><span class="h-right">Pont</span>
      </div>
      <div class="lb-meta loading" id="realMeta">
        <span><span class="refresh-dot"></span>Bet√∂lt√©s...</span>
        <span id="realUpdateTime">‚Äì</span>
      </div>
      <div class="leaderboard-body" id="realTable">
        <div style="padding:24px;text-align:center;color:var(--text-muted);font-size:.7rem;font-family:'JetBrains Mono',monospace">Bet√∂lt√©s...</div>
      </div>
    </div>
  </div>

  <!-- AI TABELLA -->
  <div id="aiContainer" style="display:none">
    <div class="section-hdr">
      <div class="section-title">
        <svg class="section-title-icon" viewBox="0 0 24 24" fill="none"><path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" fill="currentColor" stroke="currentColor" stroke-width="0.5"/></svg>
        AI El≈ërejelz√©s
        <span class="ai-badge-pill">LLM7</span>
      </div>
      <button class="btn" id="generateAIBtn">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none"><path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
        Gener√°l√°s
      </button>
    </div>
    <div class="season-notice" id="seasonNotice" style="display:none">
      <svg style="width:14px;height:14px;flex-shrink:0" viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      <span id="seasonNoticeText">√öj szezon √©rz√©kelve</span>
    </div>
    <div class="leaderboard-block">
      <div class="leaderboard-header-bar">
        <span>#</span><span></span><span>Csapat</span>
        <span class="h-right">L≈ëtt‚ÄìKapott</span><span class="h-right">GD</span><span class="h-right">Pont</span>
      </div>
      <div class="lb-meta" id="aiMeta">
        <span><span class="refresh-dot"></span>AI becsl√©s</span>
        <span id="aiUpdateTime">‚Äì</span>
      </div>
      <div class="leaderboard-body" id="aiTable">
        <div style="padding:36px;text-align:center;color:var(--text-muted);font-size:.7rem;font-family:'JetBrains Mono',monospace;line-height:2.2">
          Kattints a "Gener√°l√°s" gombra<br>
          <span style="color:#0e1e28;font-size:.58rem">Az AI elemzi a val√≥s adatokat √©s el≈ërejelz√©st k√©sz√≠t</span>
        </div>
      </div>
    </div>
    <div class="aipanel" id="aiPanel" style="display:none">
      <div class="aipanel-hdr">
        <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke="var(--green)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="aipanel-title">AI Elemz√©s</span>
        <span class="ai-badge-pill" style="margin-left:auto">llm7.io</span>
      </div>
      <div class="aibody" id="aiBody"></div>
    </div>

    <!-- TIPP GENER√ÅTOR ‚Äì csak AI f√ºl alatt -->
    <div class="tip-section">
      <div class="tip-section-hdr">
        <div class="tip-section-title">
          <svg style="width:18px;height:18px;opacity:.9" viewBox="0 0 24 24" fill="none"><path d="M9 11l3 3L22 4" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          AI Tipp Gener√°tor
          <span class="tip-badge">POISSON ¬∑ xG</span>
        </div>
      </div>
      <div id="tipDataSourceBadge" style="display:none;font-family:'JetBrains Mono',monospace;font-size:.58rem;letter-spacing:1.5px;margin-bottom:14px;padding:7px 12px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:2px;"></div>
      <div class="tip-matches-list" id="tipMatchesList"></div>
      <div class="tip-add-row">
        <button class="tip-add-btn" onclick="addMatch()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          M√©rk≈ëz√©s hozz√°ad√°sa
        </button>
      </div>
      <button class="tip-gen-btn" id="tipGenBtn" onclick="generateAllTips()">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
        AI Tippek Gener√°l√°sa
      </button>
      <div class="tip-results-list" id="tipResultsList"></div>
    </div>
  </div>

  <!-- SZEZON NAPL√ì -->
  <div id="historyContainer" style="display:none"></div>

  <div class="error-box" id="errorBox">
    <svg style="width:14px;height:14px;flex-shrink:0" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/><path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
    <span id="errorText"></span>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê PARTICLES ‚ïê‚ïê‚ïê */
const canvas=document.getElementById('particleCanvas');const ctx=canvas.getContext('2d');let W,H,particles=[];
function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;}
resize();window.addEventListener('resize',resize);
class Particle{constructor(){this.reset();}reset(){this.x=Math.random()*W;this.y=Math.random()*H;this.vx=(Math.random()-.5)*.3;this.vy=-Math.random()*.5-.1;this.size=Math.random()*1.5+.3;this.life=0;this.maxLife=Math.random()*200+100;this.green=Math.random()>.7;}update(){this.x+=this.vx;this.y+=this.vy;this.life++;if(this.life>this.maxLife||this.y<-10)this.reset();}draw(){const a=Math.sin((this.life/this.maxLife)*Math.PI)*.5;ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fillStyle=this.green?`rgba(0,230,118,${a*.7})`:`rgba(180,220,255,${a*.25})`;ctx.fill();}}
for(let i=0;i<100;i++){const p=new Particle();p.life=Math.random()*p.maxLife;particles.push(p);}
function animParticles(){ctx.clearRect(0,0,W,H);for(let i=0;i<particles.length;i++)for(let j=i+1;j<particles.length;j++){const dx=particles[i].x-particles[j].x,dy=particles[i].y-particles[j].y,d=Math.sqrt(dx*dx+dy*dy);if(d<80){ctx.beginPath();ctx.moveTo(particles[i].x,particles[i].y);ctx.lineTo(particles[j].x,particles[j].y);ctx.strokeStyle=`rgba(0,180,100,${(1-d/80)*.035})`;ctx.lineWidth=.5;ctx.stroke();}}particles.forEach(p=>{p.update();p.draw();});requestAnimationFrame(animParticles);}
animParticles();

/* ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê */
const LLM7_URL='https://api.llm7.io/v1/chat/completions';
const LLM7_KEY='/WF1cs8NieiVJAvBfBR+n5Fb/vxRW1oSmv3EqtTSTRxWQBGMexqcI4Xivs+BqTXfNYMZI8OUFZpv5YAA0FOjcumYWgcG8AkhePVVO8zCVKQo3GMYfArXw2yPPKY7w3tRvofNvQ==';
let realStandings=[],aiStandingsGlobal=[],lastSeasonId=null,lastTotalPoints=null,currentTab='real';

async function callAI(prompt,temp=0.7){
  const res=await fetch(LLM7_URL,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${LLM7_KEY}`},body:JSON.stringify({model:'default',messages:[{role:'user',content:prompt}],temperature:temp,max_tokens:2048})});
  if(!res.ok)throw new Error(`LLM7 hiba: ${res.status}`);
  const d=await res.json();
  console.log('[callAI] response keys:', Object.keys(d));
  console.log('[callAI] choices[0]:', JSON.stringify(d.choices?.[0])?.slice(0,200));
  const content = d.choices?.[0]?.message?.content || d.choices?.[0]?.text || d.result || d.response || d.content || '';
  console.log('[callAI] extracted content length:', content.length);
  return content;
}

async function fetchRealStandings(){
  const res=await fetch('/api/standings?liga=pl');
  if(!res.ok)throw new Error(`API hiba: ${res.status}`);
  const data=await res.json();
  return{standings:data.standings||[],seasonId:data.seasonId||null};
}

/* ‚ïê‚ïê‚ïê SZEZON NAPL√ì (localStorage) ‚ïê‚ïê‚ïê */
const HISTORY_KEY = 'vsport_season_history';
const MAX_SNAPSHOTS = 38;

function loadHistory() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); } catch(e){ return []; }
}
function saveHistory(h) {
  try { localStorage.setItem(HISTORY_KEY, JSON.stringify(h.slice(-MAX_SNAPSHOTS))); } catch(e){}
}
function clearHistory() {
  localStorage.removeItem(HISTORY_KEY);
  renderHistoryTab([]);
}

function snapshotStandings(standings, seasonId) {
  if (!standings || standings.length === 0) return;
  const history = loadHistory();
  // Detect total pts to estimate round
  const totalPts = standings.reduce((s,t)=>s+(t.pts||0),0);
  const totalGls = standings.reduce((s,t)=>s+(t.goalsFor||0)+(t.goalsAgainst||0),0);
  const round = Math.round(totalGls / standings.length / 2.6);

  // Don't save duplicate rounds
  const last = history[history.length-1];
  if (last) {
    const lastPts = last.standings.reduce((s,t)=>s+(t.pts||0),0);
    if (lastPts === totalPts && last.round === round) return; // no change
  }

  // If season reset detected, clear history
  if (last && last.seasonId && seasonId && last.seasonId !== seasonId) {
    history.length = 0;
  }

  history.push({
    ts: Date.now(),
    round,
    seasonId: seasonId || null,
    standings: standings.map(t=>({
      pos: t.pos, team: t.team,
      pts: t.pts||0, goalsFor: t.goalsFor||0, goalsAgainst: t.goalsAgainst||0,
      trend: t.trend||'same'
    }))
  });
  saveHistory(history);
  renderHistoryTab(history);
}

function renderHistoryTab(history) {
  const container = document.getElementById('historyContainer');
  if (!container) return;

  if (!history || history.length < 2) {
    container.innerHTML = `<div style="padding:40px;text-align:center;color:var(--text-muted);font-family:'JetBrains Mono',monospace;font-size:.7rem;line-height:2">
      M√©g nincs el√©g adat a napl√≥ megjelen√≠t√©s√©hez.<br>
      <span style="color:#0e1e28;font-size:.58rem">Az oldal minden 30 m√°sodpercben friss√≠ti az adatokat √©s menti a v√°ltoz√°sokat.</span>
    </div>`;
    return;
  }

  // Build per-team history
  const teams = {};
  history.forEach(snap => {
    snap.standings.forEach(t => {
      if (!teams[t.team]) teams[t.team] = [];
      teams[t.team].push({ round: snap.round, pts: t.pts, gf: t.goalsFor, ga: t.goalsAgainst, pos: t.pos, ts: snap.ts });
    });
  });

  const rounds = [...new Set(history.map(s=>s.round))].sort((a,b)=>a-b);
  const latest = history[history.length-1].standings.sort((a,b)=>a.pos-b.pos);

  // Change indicators between first and last snapshot
  const first = history[0].standings;
  const last2 = history[history.length-1].standings;

  const getFirst = (team) => first.find(t=>t.team===team);
  const getLast = (team) => last2.find(t=>t.team===team);

  container.innerHTML = `
    <div class="section-hdr" style="margin-bottom:16px">
      <div class="section-title">
        <svg class="section-title-icon" viewBox="0 0 24 24" fill="none"><path d="M3 3v18h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M7 16l4-4 4 4 4-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Szezon Napl√≥
        <span class="ai-badge-pill">${rounds.length} snapshot</span>
      </div>
      <button class="btn" onclick="clearHistory()" style="border-color:rgba(255,61,61,0.2);color:var(--red)">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        T√∂rl√©s
      </button>
    </div>

    <div class="history-info-bar">
      <span>üìÖ ${rounds.length} fordul√≥nyi adat ¬∑ ${new Date(history[0].ts).toLocaleDateString('hu-HU')} ‚Äì ${new Date(history[history.length-1].ts).toLocaleDateString('hu-HU')}</span>
      <span style="color:var(--green)">‚ñ≤ felfel√©</span>
      <span style="color:var(--red)">‚ñº esett</span>
    </div>

    <div class="leaderboard-block">
      <div class="history-header-bar">
        <span style="width:28px">#</span>
        <span style="flex:1">Csapat</span>
        <span class="h-center">Pont Œî</span>
        <span class="h-center">L≈ëtt Œî</span>
        <span class="h-center">Kapott Œî</span>
        <span class="h-center">Pos Œî</span>
        <span class="h-right" style="min-width:50px">Most</span>
      </div>
      <div class="leaderboard-body">
        ${latest.map((t,i) => {
          const f = getFirst(t.team);
          const l = getLast(t.team);
          if (!f || !l) return '';
          const ptsDiff = l.pts - f.pts;
          const gfDiff = l.gf - f.gf;
          const gaDiff = l.ga - f.ga;
          const posDiff = f.pos - l.pos; // positive = improved
          const total = latest.length;
          const rowCls = l.pos<=3?'lb-row top3':l.pos>total-3?'lb-row relegation':'lb-row';
          return `<div class="${rowCls}" style="animation-delay:${i*.02}s;grid-template-columns:28px 1fr repeat(4,60px) 50px">
            <span class="col-pos">${l.pos}</span>
            <span class="col-team"><span class="team-logo-placeholder"></span><span class="team-name">${t.team}</span></span>
            <span class="history-delta" style="color:${ptsDiff>0?'var(--green)':ptsDiff<0?'var(--red)':'var(--text-muted)'}">${ptsDiff>0?'+':''}${ptsDiff}</span>
            <span class="history-delta" style="color:${gfDiff>0?'var(--green)':gfDiff<0?'var(--red)':'var(--text-muted)'}">${gfDiff>0?'+':''}${gfDiff}</span>
            <span class="history-delta" style="color:${gaDiff<0?'var(--green)':gaDiff>0?'var(--red)':'var(--text-muted)'}">${gaDiff>0?'+':''}${gaDiff}</span>
            <span class="history-delta" style="color:${posDiff>0?'var(--green)':posDiff<0?'var(--red)':'var(--text-muted)'}">${posDiff>0?'‚ñ≤+'+posDiff:posDiff<0?'‚ñº'+posDiff:'‚Äî'}</span>
            <span class="col-pts">${l.pts}</span>
          </div>`;
        }).join('')}
      </div>
    </div>

    <div class="history-sparklines">
      <div class="history-sparklines-title">Pont alakul√°s fordul√≥nk√©nt</div>
      <div class="sparkline-grid" id="sparklineGrid"></div>
    </div>
  `;

  // Draw sparklines
  setTimeout(() => {
    const grid = document.getElementById('sparklineGrid');
    if (!grid) return;
    latest.forEach(t => {
      const teamData = teams[t.team];
      if (!teamData || teamData.length < 2) return;
      const maxPts = Math.max(...teamData.map(d=>d.pts));
      const minPts = Math.min(...teamData.map(d=>d.pts));
      const range = Math.max(1, maxPts - minPts);
      const W=120, H=36, pad=4;
      const pts = teamData.map((d,i) => {
        const x = pad + (i/(teamData.length-1||1))*(W-pad*2);
        const y = H - pad - ((d.pts-minPts)/range)*(H-pad*2);
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(' ');
      const lastPt = teamData[teamData.length-1];
      const firstPt = teamData[0];
      const rising = lastPt.pts >= firstPt.pts;
      const color = t.pos<=3?'#00e676':t.pos>latest.length-3?'#ff3d3d':'#00b8d4';
      const card = document.createElement('div');
      card.className = 'sparkline-card';
      const risingColor = rising ? 'var(--green)' : 'var(--red)';
      const risingArrow = rising ? '‚ñ≤' : '‚ñº';
      card.innerHTML = `
        <div class="sparkline-team">${t.team}</div>
        <svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
          <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>
          <circle cx="${pts.split(' ').pop().split(',')[0]}" cy="${pts.split(' ').pop().split(',')[1]}" r="2.5" fill="${color}"/>
        </svg>
        <div class="sparkline-pts">${lastPt.pts}pt <span style="color:${risingColor};font-size:.5rem">${risingArrow}</span></div>
      `;
      grid.appendChild(card);
    });
  }, 100);
}

function renderRealTable(standings){
  const table=document.getElementById('realTable'),meta=document.getElementById('realMeta');
  if(!standings||standings.length===0){table.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:.7rem">Nincs adat</div>';return;}
  const total=standings.length;
  table.innerHTML=standings.map((r,i)=>`<div class="${rowClass(r.pos,total)}" style="animation-delay:${i*.025}s"><span class="col-pos">${r.pos}</span><span class="col-trend">${trendHtml(r.trend??'same')}</span><span class="col-team">${logoHtml(r.logo)}<span class="team-name">${r.team}</span></span><span class="col-goals">${r.goalsFor??'‚Äì'}:${r.goalsAgainst??'‚Äì'}</span><span class="col-gd">${gd(r.goalsFor,r.goalsAgainst)}</span><span class="col-pts">${r.pts}</span></div>`).join('');
  meta.className='lb-meta';meta.querySelector('span:first-child').innerHTML='<span class="refresh-dot"></span>√âl≈ë adat';
  document.getElementById('realUpdateTime').textContent=nowStr();
  refreshTeamList();
}

async function loadRealTable(){
  const meta=document.getElementById('realMeta');
  meta.className='lb-meta loading';meta.querySelector('span:first-child').innerHTML='<span class="refresh-dot"></span>Bet√∂lt√©s...';
  try{
    const{standings,seasonId}=await fetchRealStandings();
    detectSeasonReset(standings,seasonId);
    realStandings=standings;
    renderRealTable(standings);
    snapshotStandings(standings, seasonId); // ‚Üê szezon napl√≥ ment√©s
  }
  catch(e){showError(e.message);meta.className='lb-meta error';meta.querySelector('span:first-child').innerHTML='<span class="refresh-dot"></span>Hiba';}
}

async function generateAITable(){
  const meta=document.getElementById('aiMeta'),aiTable=document.getElementById('aiTable'),aiPanel=document.getElementById('aiPanel');
  meta.className='lb-meta loading';meta.querySelector('span:first-child').innerHTML='<span class="refresh-dot"></span>AI gener√°l√°s...';
  aiTable.innerHTML='<div class="dots"><span></span><span></span><span></span></div>';
  aiPanel.style.display='none';hideError();
  if(realStandings.length===0){try{const{standings,seasonId}=await fetchRealStandings();detectSeasonReset(standings,seasonId);realStandings=standings;}catch(e){showError('Val√≥di adatok bet√∂lt√©se sikertelen: '+e.message);meta.className='lb-meta error';return;}}
  const totalPts=realStandings.reduce((s,t)=>s+(t.pts||0),0);
  const totalGls=realStandings.reduce((s,t)=>s+(t.goalsFor||0)+(t.goalsAgainst||0),0);
  const estPlayed=Math.round(totalGls/realStandings.length/2.6);
  const remainingRounds=38-estPlayed;
  const allTeamsData=realStandings.map(t=>`${t.pos}. ${t.team}: ${t.pts}pt, ${t.goalsFor||0}:${t.goalsAgainst||0} g√≥l, GD:${(t.goalsFor||0)-(t.goalsAgainst||0)}`).join('\n');
  const seasonNote=totalPts<100?`FONTOS: kb. ${estPlayed}. fordul√≥, m√©g ${remainingRounds} fordul√≥ van h√°tra! Becs√ºld a SZEZON V√âG√âT (38 fordul√≥)!`:`Szezon v√©ge fel√© (${estPlayed}. fordul√≥). Fin√°lis el≈ërejelz√©s!`;
  const prompt=`Te egy Premier Liga statisztikai elemz≈ë vagy. A jelenlegi tabella alapj√°n becs√ºld meg a SZEZON V√âGI v√©geredm√©nyt (38 fordul√≥)!

JELENLEGI √ÅLL√ÅS (${estPlayed}. fordul√≥ ut√°n):
${allTeamsData}

${seasonNote}

SZAB√ÅLYOK:
1. Adj RE√ÅLIS szezon v√©gi pontsz√°mokat (bajnok √°ltal√°ban 85-95pt, kies≈ëk 20-35pt)
2. A l≈ëtt/kapott g√≥lok legyenek SZEZON V√âGI tot√°lok (pl. bajnok ~80-90 l≈ëtt, kies≈ëk ~35-45 l≈ëtt)
3. Legal√°bb 4-5 csapat poz√≠ci√≥ja v√°ltozzon a jelenlegihez k√©pest
4. trend: "up" ha felfel√© megy, "down" ha esik, "same" ha stagn√°l
5. Minden sz√°m legyen INTEGER (eg√©sz sz√°m), NE lebeg≈ëpontos!
6. TILOS a val√≥s pontok/g√≥lok egyszer≈± m√°sol√°sa!

V√°laszolj KIZ√ÅR√ìLAG valid JSON t√∂mbbel, m√°s sz√∂veg N√âLK√úL:
[{"pos":1,"team":"CsapatN√©v","goalsFor":87,"goalsAgainst":32,"pts":91,"trend":"up"},{"pos":2,...}]`;
  try{
    const text=await callAI(prompt,0.85);
    console.log('[AI TABLE] Raw response length:', text.length);
    console.log('[AI TABLE] First 500 chars:', text.slice(0,500));

    // Robust JSON extraction - try multiple strategies
    let aiStandings = null;
    const clean=text.replace(/```json\s*/gi,'').replace(/```\s*/g,'').trim();

    // Strategy 1: find first [ ... ] block
    const arrStart=clean.indexOf('[');
    const arrEnd=clean.lastIndexOf(']');
    if(arrStart!==-1&&arrEnd>arrStart){
      try{
        const parsed=JSON.parse(clean.slice(arrStart,arrEnd+1));
        if(Array.isArray(parsed)&&parsed.length>0) aiStandings=parsed;
        console.log('[AI TABLE] Strategy 1 result:', parsed?.length, 'items');
      }catch(e){ console.log('[AI TABLE] Strategy 1 failed:', e.message); }
    }

    // Strategy 2: try the whole cleaned string
    if(!aiStandings){
      try{
        const parsed=JSON.parse(clean);
        if(Array.isArray(parsed)&&parsed.length>0) aiStandings=parsed;
        console.log('[AI TABLE] Strategy 2 result:', parsed?.length, 'items');
      }catch(e){ console.log('[AI TABLE] Strategy 2 failed:', e.message); }
    }

    // Strategy 3: regex extract each JSON object
    if(!aiStandings){
      const objs=[];
      const re=/\{[^{}]*"team"[^{}]*\}/g;
      let m2;
      while((m2=re.exec(clean))!==null){
        try{ objs.push(JSON.parse(m2[0])); }catch(e){}
      }
      console.log('[AI TABLE] Strategy 3 result:', objs.length, 'objects');
      if(objs.length>0) aiStandings=objs;
    }

    if(!aiStandings||aiStandings.length===0){
      // Show raw AI response in error for debugging
      const preview = text.slice(0,200).replace(/</g,'&lt;');
      document.getElementById('aiTable').innerHTML=`<div style="padding:16px;font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--red)">
        AI v√°lasz nem √©rtelmezhet≈ë JSON-k√©nt.<br><br>
        <span style="color:var(--text-muted)">Nyers v√°lasz eleje:</span><br>
        <span style="color:var(--amber)">${preview}</span>
      </div>`;
      meta.className='lb-meta error';
      meta.querySelector('span:first-child').innerHTML='<span class="refresh-dot"></span>Hiba';
      return;
    }

    const normalized=aiStandings.map((r,idx)=>({
      pos: parseInt(r.pos)||idx+1,
      team: String(r.team||r.name||'').trim(),
      goalsFor: parseInt(r.goalsFor||r.gf||r.goals_for||0)||0,
      goalsAgainst: parseInt(r.goalsAgainst||r.ga||r.goals_against||0)||0,
      pts: parseInt(r.pts||r.points||r.pt||0)||0,
      trend: r.trend||'same'
    })).filter(r=>r.team.length>0);

    if(normalized.length<10) throw new Error(`Hi√°nyos tabella (${normalized.length} csapat). Pr√≥b√°ld √∫jra!`);

    // Re-sort by pts desc if positions look wrong
    normalized.sort((a,b)=>b.pts-a.pts||b.goalsFor-a.goalsFor);
    normalized.forEach((r,i)=>r.pos=i+1);

    aiStandingsGlobal=normalized;
    const total=normalized.length;
    aiTable.innerHTML=normalized.map((r,i)=>`<div class="${rowClass(r.pos,total)}" style="animation-delay:${i*.025}s"><span class="col-pos">${r.pos}</span><span class="col-trend">${trendHtml(r.trend)}</span><span class="col-team"><span class="team-logo-placeholder"></span><span class="team-name">${r.team}</span></span><span class="col-goals">${r.goalsFor}:${r.goalsAgainst}</span><span class="col-gd">${gd(r.goalsFor,r.goalsAgainst)}</span><span class="col-pts">${r.pts}</span></div>`).join('');
    meta.className='lb-meta';meta.querySelector('span:first-child').innerHTML='<span class="refresh-dot"></span>AI szezon becsl√©s';
    document.getElementById('aiUpdateTime').textContent=nowStr();
    const top3=normalized.slice(0,3).map(t=>`${t.pos}. ${t.team} (${t.pts}pt)`).join(', ');
    const bot3=normalized.slice(-3).map(t=>`${t.pos}. ${t.team} (${t.pts}pt)`).join(', ');
    const analText=await callAI(`R√∂vid elemz√©s MAGYARUL (max 4 mondat):\nTop 3: ${top3}\nKies≈ëk: ${bot3}\nMi√©rt lehetnek ilyen helyzetben a szezon v√©g√©n?`);
    if(analText){document.getElementById('aiBody').innerHTML=analText.replace(/\n/g,'<br>');aiPanel.style.display='block';}
  }catch(e){
    showError('AI tabella hiba: '+e.message);meta.className='lb-meta error';meta.querySelector('span:first-child').innerHTML='<span class="refresh-dot"></span>Hiba';
    aiTable.innerHTML='<div style="padding:32px;text-align:center;color:var(--text-muted);font-size:.7rem;font-family:\'JetBrains Mono\',monospace">Hiba. Pr√≥b√°ld √∫jra.</div>';
  }
}

function gd(gf,ga){const d=(gf||0)-(ga||0);if(d>0)return`<span style="color:var(--green);text-shadow:0 0 6px rgba(0,230,118,0.4)">+${d}</span>`;if(d<0)return`<span style="color:var(--red)">${d}</span>`;return`<span style="color:#1a2e3d">0</span>`;}
function trendHtml(t){if(t==='up')return'<span class="trend-up">‚ñ≤</span>';if(t==='down')return'<span class="trend-down">‚ñº</span>';return'<span class="trend-same">‚Äî</span>';}
function logoHtml(logo){if(!logo)return'<span class="team-logo-placeholder"></span>';return`<img class="team-logo" src="${logo}" alt="" loading="lazy" onerror="this.style.display='none'">`;}
function rowClass(pos,total){if(pos<=3)return'lb-row top3';if(total&&pos>total-3)return'lb-row relegation';return'lb-row';}
function nowStr(){return new Date().toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function showError(msg){document.getElementById('errorText').textContent=msg;document.getElementById('errorBox').classList.add('show');}
function hideError(){document.getElementById('errorBox').classList.remove('show');}

function detectSeasonReset(standings,serverSeasonId){
  const totalPoints=standings.reduce((s,t)=>s+(t.pts||0),0);
  let isReset=false;
  if(serverSeasonId&&lastSeasonId&&serverSeasonId!==lastSeasonId)isReset=true;
  if(lastTotalPoints!==null&&lastTotalPoints>100&&totalPoints<lastTotalPoints*.3)isReset=true;
  if(isReset){document.getElementById('seasonNoticeText').textContent=serverSeasonId?`√öj szezon (ID: ${serverSeasonId})`:'Szezonv√°lt√°s';document.getElementById('seasonNotice').style.display='flex';document.getElementById('aiTable').innerHTML='<div style="padding:32px;text-align:center;color:var(--text-muted);font-size:.7rem;font-family:\'JetBrains Mono\',monospace">√öj szezon! Kattints a "Gener√°l√°s" gombra.</div>';document.getElementById('aiPanel').style.display='none';}
  lastTotalPoints=totalPoints;if(serverSeasonId)lastSeasonId=serverSeasonId;
}

function showTab(tab){
  currentTab=tab;
  ['real','ai','history'].forEach(t=>{
    const cont=document.getElementById(t+'Container');
    const btn=document.getElementById(t+'Tab');
    if(cont) cont.style.display=t===tab?'block':'none';
    if(btn) btn.classList.toggle('active',t===tab);
  });
  if(tab==='history') renderHistoryTab(loadHistory());
}

document.addEventListener('DOMContentLoaded',()=>{
  loadRealTable();
  document.getElementById('refreshRealBtn').addEventListener('click',loadRealTable);
  document.getElementById('generateAIBtn').addEventListener('click',generateAITable);
  setInterval(loadRealTable,30000);
  // Init history tab with saved data
  renderHistoryTab(loadHistory());
});
/* ‚ïê‚ïê‚ïê TIP GENERATOR v2 ‚ïê‚ïê‚ïê */
// TEAM_LIST is dynamically populated from realStandings - no hardcoded names
let TEAM_LIST = [];

function refreshTeamList() {
  const standings = realStandings && realStandings.length > 0 ? realStandings : [];
  if (standings.length > 0) {
    TEAM_LIST = standings.slice().sort((a,b)=>a.pos-b.pos).map(t=>t.team);
  }
  // Refresh all open dropdowns with new team list
  document.querySelectorAll('.custom-select-wrap').forEach(wrap => {
    if (wrap._buildOptions) wrap._buildOptions('');
  });
}

let matchCount = 0;

// Akt√≠v tabella: AI gener√°lt ha van, egy√©bk√©nt val√≥s
function activeStandings() {
  return (aiStandingsGlobal && aiStandingsGlobal.length > 0) ? aiStandingsGlobal : realStandings;
}

function getTeamStats(name) {
  const standings = activeStandings();
  if (!standings || !standings.length) return null;
  const nl = name.toLowerCase().replace(/[√°√©√≠√≥√∂≈ë√∫√º≈±]/g, c=>({√°:'a',√©:'e',√≠:'i',√≥:'o',√∂:'o',≈ë:'o',√∫:'u',√º:'u',≈±:'u'}[c]||c));
  return standings.find(t => {
    const tl = t.team.toLowerCase().replace(/[√°√©√≠√≥√∂≈ë√∫√º≈±]/g, c=>({√°:'a',√©:'e',√≠:'i',√≥:'o',√∂:'o',≈ë:'o',√∫:'u',√º:'u',≈±:'u'}[c]||c));
    return tl === nl || tl.includes(nl.split(' ')[0]) || nl.includes(tl.split(' ')[0]);
  }) || null;
}

function teamDotClass(name) {
  const s = getTeamStats(name);
  if (!s) return '';
  const total = activeStandings().length;
  if (s.pos <= 4) return 'top3-opt';
  if (s.pos > total - 3) return 'rel-opt';
  return '';
}

function buildDropdown(id, labelText, align='left') {
  const wrap = document.createElement('div');
  wrap.className = 'tip-team-wrap';

  const lbl = document.createElement('span');
  lbl.className = 'tip-label';
  lbl.textContent = labelText;
  if (align === 'right') lbl.style.textAlign = 'right';
  wrap.appendChild(lbl);

  const selWrap = document.createElement('div');
  selWrap.className = 'custom-select-wrap';
  selWrap.dataset.value = '';

  const trigger = document.createElement('div');
  trigger.className = 'custom-select-trigger';
  trigger.innerHTML = `<span class="cs-team-dot"></span><span class="cs-val placeholder">‚Äî V√°lassz csapatot ‚Äî</span><svg class="cs-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

  const dropdown = document.createElement('div');
  dropdown.className = 'cs-dropdown';

  const searchWrap = document.createElement('div');
  searchWrap.className = 'cs-search';
  searchWrap.innerHTML = `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" style="color:var(--text-muted);flex-shrink:0"><circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><input class="cs-search-input" placeholder="Keres√©s..." autocomplete="off">`;
  dropdown.appendChild(searchWrap);

  function buildOptions(filter='') {
    const existing = dropdown.querySelectorAll('.cs-option');
    existing.forEach(e=>e.remove());
    const fl = filter.toLowerCase();

    // If no teams loaded yet, show loading state
    if (TEAM_LIST.length === 0) {
      const loading = document.createElement('div');
      loading.style.cssText = 'padding:12px;text-align:center;color:var(--text-muted);font-family:JetBrains Mono,monospace;font-size:.6rem';
      loading.textContent = 'Tabella bet√∂lt√©s alatt...';
      dropdown.appendChild(loading);
      return;
    }

    TEAM_LIST.filter(t => !fl || t.toLowerCase().includes(fl)).forEach(team => {
      const opt = document.createElement('div');
      opt.className = 'cs-option ' + teamDotClass(team);
      const stats = getTeamStats(team);
      const posText = stats ? `${stats.pos}. hely` : '';
      const statsExtra = stats ? ` ¬∑ ${stats.goalsFor||0}:${stats.goalsAgainst||0} ¬∑ ${stats.pts}pt` : '';
      opt.innerHTML = `<span class="cs-opt-dot"></span><span>${team}</span><span class="cs-opt-pos" title="${statsExtra}">${posText}</span>`;
      if (selWrap.dataset.value === team) opt.classList.add('selected');
      opt.addEventListener('click', (e) => {
        e.stopPropagation();
        selWrap.dataset.value = team;
        const valEl = trigger.querySelector('.cs-val');
        valEl.textContent = team;
        valEl.classList.remove('placeholder');
        const dot = trigger.querySelector('.cs-team-dot');
        const dc = teamDotClass(team);
        dot.style.background = dc==='top3-opt'?'var(--green)':dc==='rel-opt'?'var(--red)':'var(--text-muted)';
        dot.style.boxShadow = dc==='top3-opt'?'0 0 6px rgba(0,230,118,0.5)':'';
        closeDropdown();
      });
      dropdown.appendChild(opt);
    });
  }
  // expose for refreshTeamList
  selWrap._buildOptions = buildOptions;

  function openDropdown() {
    document.querySelectorAll('.custom-select-wrap.open').forEach(w=>{ if(w!==selWrap) w.classList.remove('open'); });
    // lower z-index of all rows, raise this one
    document.querySelectorAll('.tip-match-row').forEach(r=>r.style.zIndex='1');
    const parentRow = selWrap.closest('.tip-match-row');
    if(parentRow) parentRow.style.zIndex='100';
    selWrap.classList.toggle('open');
    if (selWrap.classList.contains('open')) {
      buildOptions();
      const inp = searchWrap.querySelector('input');
      inp.value = '';
      setTimeout(()=>inp.focus(),50);
    }
  }
  function closeDropdown() {
    selWrap.classList.remove('open');
    const parentRow = selWrap.closest('.tip-match-row');
    if(parentRow) parentRow.style.zIndex='1';
  }

  trigger.addEventListener('click', e => { e.stopPropagation(); openDropdown(); });
  searchWrap.querySelector('input').addEventListener('input', e => buildOptions(e.target.value));
  searchWrap.querySelector('input').addEventListener('keydown', e => { if(e.key==='Escape') closeDropdown(); });

  buildOptions();
  selWrap.appendChild(trigger);
  selWrap.appendChild(dropdown);
  selWrap.id = id;
  wrap.appendChild(selWrap);
  return wrap;
}

document.addEventListener('click', () => {
  document.querySelectorAll('.custom-select-wrap.open').forEach(w=>w.classList.remove('open'));
  document.querySelectorAll('.tip-match-row').forEach(r=>r.style.zIndex='1');
});

function addMatch(homeVal='', awayVal='') {
  matchCount++;
  const idx = matchCount;
  const row = document.createElement('div');
  row.className = 'tip-match-row';
  row.dataset.idx = idx;
  row.style.animationDelay = '0s';

  const numEl = document.createElement('span');
  numEl.className = 'tip-match-num';
  numEl.textContent = `#${idx}`;
  row.appendChild(numEl);

  const homeWrap = buildDropdown(`tipHome_${idx}`, 'Hazai csapat', 'left');
  row.appendChild(homeWrap);

  // swap btn
  const swapWrap = document.createElement('div');
  swapWrap.className = 'tip-swap-wrap';
  swapWrap.innerHTML = `<button class="tip-swap-btn" onclick="swapMatch(${idx})" title="Csere"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 16V4m0 0L3 8m4-4l4 4" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 8v12m0 0l4-4m-4 4l-4-4" stroke="var(--cyan)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>`;
  row.appendChild(swapWrap);

  const awayWrap = buildDropdown(`tipAway_${idx}`, 'Vend√©g csapat', 'right');
  row.appendChild(awayWrap);

  // remove btn (only show if more than 1 row)
  const removeBtn = document.createElement('button');
  removeBtn.className = 'tip-remove-btn';
  removeBtn.title = 'T√∂rl√©s';
  removeBtn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;
  removeBtn.onclick = () => {
    row.style.transition='opacity .2s,transform .2s';
    row.style.opacity='0';row.style.transform='translateX(-8px)';
    setTimeout(()=>{row.remove();updateMatchNums();},200);
  };
  row.appendChild(removeBtn);

  document.getElementById('tipMatchesList').appendChild(row);

  // set initial values if provided
  if (homeVal) {
    const hw = document.getElementById(`tipHome_${idx}`);
    if(hw){ hw.dataset.value=homeVal; const v=hw.querySelector('.cs-val'); v.textContent=homeVal; v.classList.remove('placeholder'); }
  }
  if (awayVal) {
    const aw = document.getElementById(`tipAway_${idx}`);
    if(aw){ aw.dataset.value=awayVal; const v=aw.querySelector('.cs-val'); v.textContent=awayVal; v.classList.remove('placeholder'); }
  }
}

function updateMatchNums() {
  document.querySelectorAll('.tip-match-row').forEach((row,i)=>{
    row.querySelector('.tip-match-num').textContent=`#${i+1}`;
  });
}

function swapMatch(idx) {
  const hw = document.getElementById(`tipHome_${idx}`);
  const aw = document.getElementById(`tipAway_${idx}`);
  if (!hw || !aw) return;
  const tmp = hw.dataset.value;
  const tmpHtml = hw.querySelector('.cs-val').textContent;
  const tmpClass = hw.querySelector('.cs-val').classList.contains('placeholder');

  const setVal = (wrap, val) => {
    wrap.dataset.value = val;
    const v = wrap.querySelector('.cs-val');
    if (!val) { v.textContent='‚Äî V√°lassz csapatot ‚Äî'; v.classList.add('placeholder'); }
    else { v.textContent=val; v.classList.remove('placeholder'); }
    const dot = wrap.querySelector('.cs-team-dot');
    const dc = teamDotClass(val);
    dot.style.background = dc==='top3-opt'?'var(--green)':dc==='rel-opt'?'var(--red)':'var(--text-muted)';
    dot.style.boxShadow = dc==='top3-opt'?'0 0 6px rgba(0,230,118,0.5)':'';
  };

  const awayVal = aw.dataset.value;
  setVal(hw, awayVal);
  setVal(aw, tmp);

  // spin animation
  const btn = hw.closest('.tip-match-row').querySelector('.tip-swap-btn');
  btn.classList.add('spinning');
  setTimeout(()=>btn.classList.remove('spinning'),450);
}

function buildStandingsContext() {
  const standings = activeStandings();
  const isAI = aiStandingsGlobal && aiStandingsGlobal.length > 0;
  if (!standings || !standings.length) return null;
  const totalGls = standings.reduce((s,t)=>s+(t.goalsFor||0)+(t.goalsAgainst||0),0);
  const estMatches = Math.round(totalGls / standings.length / 2.6);
  const played = Math.max(1, estMatches);
  const lines = standings.map(t => {
    const gf=t.goalsFor||0, ga=t.goalsAgainst||0;
    const pts=t.pts||0;
    const gd=gf-ga;
    const avgGf=(gf/played).toFixed(2);
    const avgGa=(ga/played).toFixed(2);
    const avgPts=(pts/played).toFixed(2);
    return `${t.pos}. ${t.team}: ${pts}pt (${avgPts}/m), L≈ëtt:${gf}(${avgGf}/m), Kapott:${ga}(${avgGa}/m), GD:${gd>0?'+':''}${gd}${t.trend?', trend:'+t.trend:''}`;
  });
  const totalPts=standings.reduce((s,t)=>s+(t.pts||0),0);
  const sourceLabel = isAI ? 'AI EL≈êREJELZ√âS (szezon v√©ge becsl√©s)' : 'VAL√ìS TABELLA';
  return { ctx: `PREMIER LIGA ‚Äì ${sourceLabel} ‚Äì kb. ${played}. fordul√≥\nLiga √°tlag g√≥l/m√©rk≈ëz√©s: ${(totalGls/Math.max(1,played*standings.length/2)).toFixed(2)}\n\n${sourceLabel}:\n${lines.join('\n')}`, played, isAI };
}

// Poisson distribution P(X=k) = e^(-lambda) * lambda^k / k!
function poisson(lambda, k) {
  let p = Math.exp(-lambda);
  for(let i=1;i<=k;i++) p *= lambda/i;
  return p;
}

// Compute match probabilities using Dixon-Coles inspired model
function calcMatchProbs(homeStats, awayStats, played) {
  const PL_AVG_HOME = 1.53, PL_AVG_AWAY = 1.13; // PL historical averages
  const p = Math.max(1, played);

  const homeAttack  = homeStats ? (homeStats.goalsFor||0)/p/PL_AVG_HOME : 1.0;
  const homeDefense = homeStats ? (homeStats.goalsAgainst||0)/p/PL_AVG_AWAY : 1.0;
  const awayAttack  = awayStats ? (awayStats.goalsFor||0)/p/PL_AVG_AWAY : 1.0;
  const awayDefense = awayStats ? (awayStats.goalsAgainst||0)/p/PL_AVG_HOME : 1.0;

  const lambdaHome = homeAttack * awayDefense * PL_AVG_HOME;
  const lambdaAway = awayAttack * homeDefense * PL_AVG_AWAY;

  // Clamp to reasonable range
  const lH = Math.min(Math.max(lambdaHome, 0.3), 4.0);
  const lA = Math.min(Math.max(lambdaAway, 0.3), 4.0);

  // Build score matrix up to 6 goals each
  let probBTTS=0, probOver15=0, probOver25=0, probOver35=0, probOver45=0;
  let totalProb=0;
  for(let h=0;h<=6;h++){
    for(let a=0;a<=6;a++){
      const p2 = poisson(lH,h)*poisson(lA,a);
      totalProb+=p2;
      const tot=h+a;
      if(h>0&&a>0) probBTTS+=p2;
      if(tot>1) probOver15+=p2;
      if(tot>2) probOver25+=p2;
      if(tot>3) probOver35+=p2;
      if(tot>4) probOver45+=p2;
    }
  }
  // normalize
  const n = totalProb || 1;
  return {
    lambdaHome: lH.toFixed(2),
    lambdaAway: lA.toFixed(2),
    expectedTotal: (lH+lA).toFixed(2),
    btts: (probBTTS/n*100).toFixed(1),
    over15: (probOver15/n*100).toFixed(1),
    over25: (probOver25/n*100).toFixed(1),
    over35: (probOver35/n*100).toFixed(1),
    over45: (probOver45/n*100).toFixed(1),
  };
}

async function generateAllTips() {
  const rows = document.querySelectorAll('.tip-match-row');
  const matches = [];
  let hasEmpty = false;
  rows.forEach(row => {
    const idx = row.dataset.idx;
    const hw = document.getElementById(`tipHome_${idx}`);
    const aw = document.getElementById(`tipAway_${idx}`);
    const home = hw?.dataset.value || '';
    const away = aw?.dataset.value || '';
    if (!home || !away || home===away) { hasEmpty=true; return; }
    matches.push({home, away});
  });

  if (!matches.length || hasEmpty) { showError('Minden m√©rk≈ëz√©sn√©l v√°lassz k√©t k√ºl√∂nb√∂z≈ë csapatot!'); return; }
  hideError();

  const btn = document.getElementById('tipGenBtn');
  const resultsList = document.getElementById('tipResultsList');
  btn.disabled = true;
  resultsList.innerHTML = '';

  // === AUTO-LOAD STANDINGS IF MISSING ===
  if (!realStandings || realStandings.length === 0) {
    btn.innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
    try {
      const {standings, seasonId} = await fetchRealStandings();
      detectSeasonReset(standings, seasonId);
      realStandings = standings;
      renderRealTable(standings);
    } catch(e) {
      showError('Tabella bet√∂lt√©s sikertelen. K√©rlek friss√≠tsd az oldalt!');
      btn.disabled = false;
      btn.innerHTML = GENBTN_HTML;
      return;
    }
  }

  const usingAI = aiStandingsGlobal && aiStandingsGlobal.length > 0;

  btn.innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';

  const standingData = buildStandingsContext();
  const standingsCtx = standingData?.ctx || 'Tabella nem el√©rhet≈ë.';
  const played = standingData?.played || 20;
  const usingAIData = standingData?.isAI || false;

  // Show which data source is active
  const srcBadge = document.getElementById('tipDataSourceBadge');
  if (srcBadge) {
    srcBadge.textContent = usingAIData ? 'ü§ñ AI el≈ërejelz√©s alapj√°n' : 'üìä Val√≥s tabella alapj√°n';
    srcBadge.style.color = usingAIData ? 'var(--green)' : 'var(--cyan)';
    srcBadge.style.display = 'block';
  }

  // Generate all tips in parallel
  const promises = matches.map((m, i) => generateOneTip(m.home, m.away, i+1, standingsCtx, played));
  const results = await Promise.allSettled(promises);

  results.forEach((res, i) => {
    const block = document.createElement('div');
    block.style.animation=`rowSlide .4s ease ${i*.1}s both`;
    if (res.status === 'fulfilled') {
      block.className='tip-result-block';
      block.innerHTML = res.value;
      resultsList.appendChild(block);
      setTimeout(() => {
        block.querySelectorAll('.tip-card-conf-fill').forEach(bar => {
          bar.style.width = bar.dataset.conf + '%';
        });
        // animate progress ring
        block.querySelectorAll('.conf-ring-fill').forEach(ring => {
          const v = parseFloat(ring.dataset.conf||0);
          const circ = 2*Math.PI*20;
          ring.style.strokeDashoffset = circ - (circ*v/100);
        });
      }, 150 + i*100);
    } else {
      block.className='tip-result-block';
      block.style.padding='16px 20px';
      block.innerHTML=`<span style="color:var(--red);font-family:'JetBrains Mono',monospace;font-size:.65rem">‚ö† M√©rk≈ëz√©s #${i+1} hiba: ${res.reason?.message||'ismeretlen hiba'}</span>`;
      resultsList.appendChild(block);
    }
  });

  btn.disabled = false;
  btn.innerHTML = GENBTN_HTML;
}

const GENBTN_HTML = `<svg viewBox="0 0 24 24" fill="none" style="width:15px;height:15px"><path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg> AI Tippek Gener√°l√°sa`;

function calcBestTip(btts, o15, o25, o35) {
  // Pick whichever has highest "edge" from 50% (most decisive)
  const vals = [
    {k:'btts',  v: Math.abs(btts-50),  p: btts},
    {k:'over15',v: Math.abs(o15-50),   p: o15},
    {k:'over25',v: Math.abs(o25-50),   p: o25},
    {k:'over35',v: Math.abs(o35-50),   p: o35},
  ];
  // prefer the one with highest probability that's above 50
  const above50 = vals.filter(x=>x.p>50).sort((a,b)=>b.v-a.v);
  if (above50.length) return above50[0].k;
  // fallback: highest confidence even if below 50
  return vals.sort((a,b)=>b.v-a.v)[0].k;
}

async function generateOneTip(home, away, num, standingsCtx, played) {
  const homeStats = getTeamStats(home);
  const awayStats = getTeamStats(away);
  const probs = calcMatchProbs(homeStats, awayStats, played);

  // Determine pre-calculated picks based on Poisson model
  const bttsProb  = parseFloat(probs.btts);
  const o15Prob   = parseFloat(probs.over15);
  const o25Prob   = parseFloat(probs.over25);
  const o35Prob   = parseFloat(probs.over35);

  const homeRank = homeStats?.pos || '?';
  const awayRank = awayStats?.pos || '?';
  const homeForm = homeStats?.trend || 'same';
  const awayForm = awayStats?.trend || 'same';

  const prompt = `Te egy profi sportfogad√°si quant-elemz≈ë vagy, aki Premier Liga adatokb√≥l Poisson-modellel sz√°mol val√≥sz√≠n≈±s√©geket.

${standingsCtx}

‚îÅ‚îÅ‚îÅ ELEMZEND≈ê M√âRK≈êZ√âS ‚îÅ‚îÅ‚îÅ
${home} (hazai, ${homeRank}. hely, trend: ${homeForm}) vs ${away} (vend√©g, ${awayRank}. hely, trend: ${awayForm})

‚îÅ‚îÅ‚îÅ POISSON xG MODELL EREDM√âNY ‚îÅ‚îÅ‚îÅ
- ${home} v√°rhat√≥ g√≥lok (Œª): ${probs.lambdaHome}
- ${away} v√°rhat√≥ g√≥lok (Œª): ${probs.lambdaAway}
- V√°rhat√≥ √∂sszes g√≥l: ${probs.expectedTotal}
- BTTS val√≥sz√≠n≈±s√©g: ${probs.btts}%
- Over 1.5 val√≥sz√≠n≈±s√©g: ${probs.over15}%
- Over 2.5 val√≥sz√≠n≈±s√©g: ${probs.over25}%
- Over 3.5 val√≥sz√≠n≈±s√©g: ${probs.over35}%

‚îÅ‚îÅ‚îÅ FELADATOD ‚îÅ‚îÅ‚îÅ
A Poisson modell eredm√©nyei ALAPJ√ÅN (ne ellentmondj nekik!):
1. A confidence √©rt√©kek legyenek K√ñZEL a Poisson val√≥sz√≠n≈±s√©gekhez (¬±5-8%)
2. A pick (Igen/Nem) feleljen meg a Poisson val√≥sz√≠n≈±s√©gnek: ha >50% akkor Igen, ha <50% akkor Nem
3. best_tip: azt v√°laszd amelynek a legjobb value van (legmagasabb val√≥sz√≠n≈±s√©g √©s legink√°bb elt√©r az 50%-t√≥l)
4. Az elemz√©s hivatkozzon a konkr√©t tabella-sz√°mokra, g√≥l-√°tlagokra, √©s a Poisson modell eredm√©ny√©re

V√°laszolj CSAK valid JSON-nal, pontosan ebben a strukt√∫r√°ban:
{"btts":{"pick":"${bttsProb>50?'Igen':'Nem'}","confidence":${Math.round(bttsProb)}},"over15":{"pick":${o15Prob>50},"confidence":${Math.round(o15Prob)}},"over25":{"pick":${o25Prob>50},"confidence":${Math.round(o25Prob)}},"over35":{"pick":${o35Prob>50},"confidence":${Math.round(o35Prob)}},"best_tip":"${calcBestTip(bttsProb,o15Prob,o25Prob,o35Prob)}","expected_home":${probs.lambdaHome},"expected_away":${probs.lambdaAway},"analysis":"3 mondatos MAGYAR elemz√©s konkr√©t sz√°mokkal: g√≥ltermel√©s/m√©rk≈ëz√©s, mit mutat a Poisson modell, melyik a legjobb tipp"}`;

  let data;
  try {
    const text = await callAI(prompt, 0.3);
    const clean = text.replace(/```json\s*/gi,'').replace(/```\s*/g,'').trim();
    const start = clean.indexOf('{');
    if (start===-1) throw new Error('JSON parse hiba');
    data = JSON.parse(clean.slice(start));
  } catch(e) {
    // Fallback: use pure Poisson values if AI fails
    data = {
      btts: { pick: bttsProb>50?'Igen':'Nem', confidence: Math.round(bttsProb) },
      over15: { pick: o15Prob>50, confidence: Math.round(o15Prob) },
      over25: { pick: o25Prob>50, confidence: Math.round(o25Prob) },
      over35: { pick: o35Prob>50, confidence: Math.round(o35Prob) },
      best_tip: ['btts','over15','over25','over35'][[bttsProb,o15Prob,o25Prob,o35Prob].indexOf(Math.max(bttsProb,o15Prob,o25Prob,o35Prob))],
      expected_home: probs.lambdaHome,
      expected_away: probs.lambdaAway,
      analysis: `A Poisson-modell alapj√°n: ${home} v√°rhat√≥ ${probs.lambdaHome} g√≥l, ${away} ${probs.lambdaAway} g√≥l. √ñsszesen ${probs.expectedTotal} g√≥l v√°rhat√≥.`
    };
  }

  // Safety: override confidence with Poisson values if AI went off-rails
  const safeConf = (aiConf, poissonVal) => {
    const diff = Math.abs(aiConf - poissonVal);
    return diff > 15 ? Math.round((aiConf + poissonVal)/2) : aiConf;
  };
  const bttsConf  = safeConf(data.btts?.confidence||bttsProb, bttsProb);
  const o15Conf   = safeConf(data.over15?.confidence||o15Prob, o15Prob);
  const o25Conf   = safeConf(data.over25?.confidence||o25Prob, o25Prob);
  const o35Conf   = safeConf(data.over35?.confidence||o35Prob, o35Prob);

  const bttsYes   = (data.btts?.pick||'').toString().toLowerCase().includes('igen') || bttsProb>50;
  const o15Yes    = data.over15?.pick===true || data.over15?.pick==='true' || o15Prob>50;
  const o25Yes    = data.over25?.pick===true || data.over25?.pick==='true' || o25Prob>50;
  const o35Yes    = data.over35?.pick===true || data.over35?.pick==='true' || o35Prob>50;

  const bestTip   = data.best_tip || 'over15';
  const xgH = data.expected_home || probs.lambdaHome;
  const xgA = data.expected_away || probs.lambdaAway;
  const xgTot = (parseFloat(xgH)+parseFloat(xgA)).toFixed(2);

  // Confidence color
  const confColor = (c) => c>=70?'var(--green)':c>=50?'var(--amber)':'var(--red)';

  return `
    <div class="tip-result-hdr">
      <span class="tip-match-idx">#${num}</span>
      <div class="tip-vs-label">
        <span class="tip-team-name ${homeStats&&homeStats.pos<=4?'tip-name-top':''}">${home}</span>
        <span class="tip-vs-sep">VS</span>
        <span class="tip-team-name ${awayStats&&awayStats.pos<=4?'tip-name-top':''}">${away}</span>
      </div>
      <span class="ai-badge-pill" style="margin-left:auto">POISSON ¬∑ AI</span>
    </div>

    <div class="tip-xg-banner">
      <div class="tip-xg-side">
        <span class="tip-xg-team">${home}</span>
        <span class="tip-xg-val">${xgH}</span>
        <span class="tip-xg-label">xG</span>
        ${homeStats?`<span class="tip-xg-sub">${homeStats.pos}. hely ¬∑ ${((homeStats.goalsFor||0)/Math.max(1,played)).toFixed(2)} g√≥l/m</span>`:''}
      </div>
      <div class="tip-xg-center">
        <div class="tip-xg-total-wrap">
          <span class="tip-xg-total-val">${xgTot}</span>
          <span class="tip-xg-total-lbl">v√°rhat√≥ g√≥l</span>
        </div>
        <div class="tip-xg-divider"></div>
      </div>
      <div class="tip-xg-side tip-xg-right">
        <span class="tip-xg-team">${away}</span>
        <span class="tip-xg-val">${xgA}</span>
        <span class="tip-xg-label">xG</span>
        ${awayStats?`<span class="tip-xg-sub">${awayStats.pos}. hely ¬∑ ${((awayStats.goalsFor||0)/Math.max(1,played)).toFixed(2)} g√≥l/m</span>`:''}
      </div>
    </div>

    <div class="tip-cards">
      ${buildCard2('BTTS', 'Mindk√©t csapat g√≥lt szerez', bttsYes?'IGEN':'NEM', bttsConf, bestTip==='btts', probs.btts+'%', 0)}
      ${buildCard2('O1.5', 'Over 1.5 g√≥l', o15Yes?'IGEN':'NEM', o15Conf, bestTip==='over15', probs.over15+'%', 1)}
      ${buildCard2('O2.5', 'Over 2.5 g√≥l', o25Yes?'IGEN':'NEM', o25Conf, bestTip==='over25', probs.over25+'%', 2)}
      ${buildCard2('O3.5', 'Over 3.5 g√≥l', o35Yes?'IGEN':'NEM', o35Conf, bestTip==='over35', probs.over35+'%', 3)}
    </div>

    ${data.analysis ? `
    <div class="tip-analysis">
      <span class="tip-analysis-label">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" style="margin-right:4px"><path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" fill="currentColor"/></svg>
        AI Elemz√©s
      </span>
      <div class="tip-analysis-text">${data.analysis}</div>
    </div>` : ''}
  `;
}

function buildCard2(code, name, val, conf, highlighted, poissonStat, delay) {
  const isYes = val==='IGEN';
  const valColor = isYes ? 'var(--green)' : 'var(--red)';
  const confPct = Math.min(100, Math.max(0, conf));
  const circ = 2*Math.PI*20;
  return `<div class="tip-card2 ${highlighted?'highlighted':''}" style="animation-delay:${delay*.07}s">
    ${highlighted?'<div class="tip-card2-best-badge">‚òÖ LEGJOBB TIPP</div>':''}
    <div class="tip-card2-code">${code}</div>
    <div class="tip-card2-name">${name}</div>
    <div class="tip-card2-pick" style="color:${valColor}">${val}</div>
    <div class="tip-card2-ring-wrap">
      <svg width="48" height="48" viewBox="0 0 48 48">
        <circle cx="24" cy="24" r="20" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="3"/>
        <circle class="conf-ring-fill" cx="24" cy="24" r="20" fill="none" stroke="${highlighted?'var(--green)':'var(--cyan)'}" stroke-width="3"
          stroke-dasharray="${circ}" stroke-dashoffset="${circ}"
          stroke-linecap="round" transform="rotate(-90 24 24)"
          data-conf="${confPct}" style="transition:stroke-dashoffset .9s cubic-bezier(.16,1,.3,1)"/>
        <text x="24" y="28" text-anchor="middle" fill="${highlighted?'var(--green)':'#d4e8f0'}" font-family="JetBrains Mono" font-size="9" font-weight="700">${confPct}%</text>
      </svg>
    </div>
    <div class="tip-card2-stat">Poisson: ${poissonStat}</div>
  </div>`;
}

// Initialize with one match row
addMatch();
</script>
</html>
