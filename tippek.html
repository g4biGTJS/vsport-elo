<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VSPORT â€“ Forma & TeljesÃ­tmÃ©ny</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { background: #0a0a0a; color: #fff; font-family: 'Segoe UI', sans-serif; min-height: 100vh; }

    /* â”€â”€ HEADER (pont ugyanaz, mint index.html) â”€â”€ */
    header {
      background: #111; border-bottom: 2px solid #222;
      padding: 0 20px; height: 44px;
      display: flex; align-items: center; gap: 10px;
      position: sticky; top: 0; z-index: 100;
    }
    .dot { width: 9px; height: 9px; border-radius: 50%; background: #fff; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.25} }
    header h1 { font-size:.85rem; font-weight:600; letter-spacing:3px; text-transform:uppercase; color:#ddd; }
    .back-btn {
      display: flex; align-items: center; gap: 5px;
      color: #888; font-size: .75rem; text-decoration: none;
      padding: 5px 10px; border: 1px solid #222; border-radius: 4px;
      transition: all .15s;
    }
    .back-btn:hover { color: #fff; border-color: #444; }
    .header-sep { width: 1px; height: 18px; background: #222; margin: 0 5px; }

    /* â”€â”€ FORM TABLE (ugyanaz a design, mint a leaderboard) â”€â”€ */
    .page { max-width: 900px; margin: 0 auto; padding: 20px 16px 40px; }

    .form-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
    }
    .title-section {
      display: flex; align-items: center; gap: 10px;
    }
    .title-section h2 {
      font-size: 1rem; font-weight: 600; letter-spacing: 2px;
      text-transform: uppercase; color: #ddd;
    }
    .season-badge {
      background: #1e6b1e; color: #fff; font-size: .6rem;
      padding: 3px 8px; border-radius: 3px; font-weight: 600;
      letter-spacing: 0.5px;
    }
    .season-badge.new { background: #f59e0b; animation: pulse 2s infinite; }

    .controls {
      display: flex; gap: 8px; align-items: center;
    }
    .matches-select {
      background: #111; border: 1px solid #2a2a2a; color: #fff;
      font-size: .7rem; padding: 5px 8px; border-radius: 4px;
      font-family: inherit; cursor: pointer;
    }
    .matches-select:hover { border-color: #444; }
    .refresh-btn {
      background: #1a1a1a; border: 1px solid #333; color: #aaa;
      font-size: .7rem; padding: 5px 12px; border-radius: 4px;
      cursor: pointer; transition: all .15s;
    }
    .refresh-btn:hover { background: #242424; border-color: #555; color: #fff; }

    /* Leaderboard tÃ¡blÃ¡zat (pont ugyanaz, mint index.html) */
    .leaderboard-block { background:#111; border:1px solid #2a2a2a; border-radius:4px; overflow:hidden; margin-bottom: 20px; }
    .leaderboard-header-bar {
      background:#1e6b1e;
      display:grid;
      grid-template-columns: 26px 1fr 60px 70px 60px;
      align-items:center; padding:7px 10px; gap:4px;
    }
    .leaderboard-header-bar span { font-size:.58rem; font-weight:700; color:#fff; text-transform:uppercase; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .leaderboard-header-bar .h-right { text-align:right; }

    .lb-meta {
      background:#0f0f0f; border-bottom:1px solid #1e1e1e;
      padding:4px 10px; font-size:.6rem; color:#444;
      display:flex; justify-content:space-between; align-items:center;
    }
    .refresh-dot { width:5px; height:5px; border-radius:50%; background:#3d8b3d; display:inline-block; margin-right:4px; animation:pulse 2s infinite; }
    .lb-meta.loading .refresh-dot { background:#f59e0b; }
    .lb-meta.error   .refresh-dot { background:#e53935; }

    .leaderboard-body { background:#141414; }

    .lb-row {
      display:grid;
      grid-template-columns: 26px 1fr 60px 70px 60px;
      align-items:center; padding:4px 10px; gap:4px;
      border-bottom:1px solid #1d1d1d; transition:background .12s;
    }
    .lb-row:last-child { border-bottom:none; }
    .lb-row:hover { background:#1c1c1c; }
    .lb-row.top3 { background:#162316; }
    .lb-row.top3:hover { background:#1c2b1c; }
    .lb-row.bottom3 { background:#1a1010; }
    .lb-row.bottom3:hover { background:#231414; }

    .col-pos { font-size:.7rem; font-weight:700; color:#666; text-align:center; }
    .lb-row.top3 .col-pos { color:#4caf50; }
    .lb-row.bottom3 .col-pos { color:#e53935; }

    .col-team { display:flex; align-items:center; gap:6px; }
    .team-logo { width:16px; height:16px; object-fit:contain; flex-shrink:0; }
    .team-logo-placeholder { width:16px; height:16px; flex-shrink:0; }
    .team-name { font-size:.76rem; font-weight:600; color:#ccc; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .col-form { font-size:.68rem; color:#aaa; text-align:center; font-family: monospace; letter-spacing: 1px; }
    .col-avg { font-size:.65rem; color:#4caf50; text-align:right; font-weight: 600; }
    .col-pts { font-size:.8rem; font-weight:800; color:#fff; text-align:right; font-variant-numeric:tabular-nums; }

    .trend-indicator { display: inline-block; margin-left: 3px; font-size: .6rem; }
    .trend-up { color: #4caf50; }
    .trend-down { color: #e53935; }
    .trend-same { color: #666; }

    /* Statisztika kÃ¡rtyÃ¡k */
    .stats-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: #111; border: 1px solid #2a2a2a; border-radius: 4px;
      padding: 12px 10px; text-align: center;
    }
    .stat-label {
      font-size: .6rem; text-transform: uppercase; color: #666;
      letter-spacing: 1px; margin-bottom: 5px;
    }
    .stat-value {
      font-size: 1.2rem; font-weight: 700; color: #fff;
    }
    .stat-value small { font-size: .7rem; color: #4caf50; margin-left: 4px; }

    /* AI ElemzÃ©s panel (stÃ­lusban illeszkedik) */
    .aipanel {
      background: #111; border: 1px solid #2a2a2a; border-radius: 4px;
      overflow: hidden; margin-top: 20px;
    }
    .aipanel.show { display: block; }
    .aipanel-hdr {
      background: #1a1a1a; border-bottom: 1px solid #2a2a2a;
      padding: 10px 16px; display: flex; align-items: center; gap: 10px;
    }
    .aipanel-title {
      font-size: .8rem; font-weight: 600; letter-spacing: 1px;
      text-transform: uppercase; color: #ddd;
    }
    .ai-badge {
      font-size: .55rem; background: #333; color: #aaa;
      padding: 2px 6px; border-radius: 3px; letter-spacing: 1px;
    }
    .aibody {
      padding: 16px 20px; font-size: .82rem; line-height: 1.7;
      color: #ccc; min-height: 80px;
    }
    .aibody.typing::after { content: 'â–‹'; color: #4caf50; animation: cur .6s infinite; }
    @keyframes cur { 0%,100%{opacity:1} 50%{opacity:0} }

    .dots { display: flex; gap: 5px; padding: 10px 0; }
    .dots span {
      width: 6px; height: 6px; border-radius: 50%; background: #4caf50;
      opacity: .4; animation: d 1s infinite;
    }
    .dots span:nth-child(2){ animation-delay:.2s; }
    .dots span:nth-child(3){ animation-delay:.4s; }
    @keyframes d { 0%,100%{opacity:.4} 50%{opacity:1} }

    .error-box {
      background: rgba(229, 57, 53, 0.1); border: 1px solid rgba(229, 57, 53, 0.2);
      border-radius: 4px; padding: 12px 16px; font-size: .78rem;
      color: #ff8a80; margin-bottom: 16px; display: none;
    }
    .error-box.show { display: block; }

    @media (max-width:560px) {
      .stats-grid { grid-template-columns: 1fr; }
      .leaderboard-header-bar { grid-template-columns: 26px 1fr 50px 60px 50px; }
    }
  </style>
</head>
<body>

<header>
  <a class="back-btn" href="/">â† Vissza</a>
  <div class="header-sep"></div>
  <div class="dot"></div>
  <h1>VSPORT &mdash; Forma & TeljesÃ­tmÃ©ny</h1>
</header>

<div class="page">
  <!-- FejlÃ©c + vezÃ©rlÅ‘k -->
  <div class="form-header">
    <div class="title-section">
      <h2>âš¡ Legjobb formÃ¡ban lÃ©vÅ‘ csapatok</h2>
      <span class="season-badge" id="seasonBadge">AktÃ­v szezon</span>
    </div>
    <div class="controls">
      <select class="matches-select" id="matchCountSelect">
        <option value="3">UtolsÃ³ 3 meccs</option>
        <option value="5" selected>UtolsÃ³ 5 meccs</option>
        <option value="8">UtolsÃ³ 8 meccs</option>
        <option value="10">UtolsÃ³ 10 meccs</option>
      </select>
      <button class="refresh-btn" onclick="loadData()">ğŸ”„ FrissÃ­tÃ©s</button>
    </div>
  </div>

  <!-- Gyors statisztikÃ¡k -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card">
      <div class="stat-label">Legjobb forma</div>
      <div class="stat-value" id="bestTeamStat">â€“</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Ãtlag pont/meccs</div>
      <div class="stat-value" id="avgPtsStat">â€“ <small>(top 5)</small></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">LejÃ¡tszott meccsek</div>
      <div class="stat-value" id="matchesCountStat">â€“</div>
    </div>
  </div>

  <!-- Forma tÃ¡blÃ¡zat (leaderboard stÃ­lusban) -->
  <div class="leaderboard-block">
    <div class="leaderboard-header-bar">
      <span>#</span>
      <span>Csapat</span>
      <span class="h-right">Forma</span>
      <span class="h-right">Pont/Meccs</span>
      <span class="h-right">Pont</span>
    </div>
    <div class="lb-meta loading" id="formMeta">
      <span><span class="refresh-dot"></span>Forma szÃ¡mÃ­tÃ¡s...</span>
      <span id="updateTime">â€“</span>
    </div>
    <div class="leaderboard-body" id="formTable">
      <div class="lb-skeleton" style="padding:8px 10px">
        <div style="height:20px; background:#1a1a1a; border-radius:3px; margin-bottom:5px;"></div>
        <div style="height:20px; background:#1a1a1a; border-radius:3px; margin-bottom:5px;"></div>
        <div style="height:20px; background:#1a1a1a; border-radius:3px;"></div>
      </div>
    </div>
  </div>

  <!-- AI ElemzÃ©s panel -->
  <div class="aipanel" id="aiPanel">
    <div class="aipanel-hdr">
      <span class="aipanel-title">ğŸ“Š AI Forma ElemzÃ©s</span>
      <span class="ai-badge">gemini-2.0</span>
    </div>
    <div class="aibody" id="aiBody">
      <div class="dots"><span></span><span></span><span></span></div>
    </div>
  </div>

  <!-- HibaÃ¼zenet -->
  <div class="error-box" id="errorBox"></div>
</div>

<script>
const LOGO_BASE = 'https://vgls.betradar.com/ls/s5_crest/scigamingvirtuals/medium/';
const SR_URL = 'https://s5.sir.sportradar.com/scigamingvirtuals/hu/1/season/3061057';
const CORS_PROXY = 'https://corsproxy.io/?url=';
const GEMINI_KEY = 'AIzaSyD6tfnMdM2_FdYjL6QQuXYjq7BVkfUvizg';

// State
let allMatches = [];        // Ã–sszes betÃ¶ltÃ¶tt meccs
let formData = [];          // SzÃ¡mÃ­tott form adatok
let currentSeason = 1;      // Szezon azonosÃ­tÃ³
let lastPointsSum = 0;      // UtolsÃ³ Ã¶sszpontszÃ¡m (szezonvÃ¡ltÃ¡s detektÃ¡lÃ¡shoz)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1. MEccsek betÃ¶ltÃ©se Ã©s parse-olÃ¡sa
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchMatches() {
  // PrÃ³ba 1: kÃ¶zvetlen fetch
  try {
    const r = await fetch(SR_URL, { headers: { 'Accept': 'text/html' } });
    if (r.ok) {
      const html = await r.text();
      const matches = parseMatches(html);
      if (matches.length > 0) return matches;
    }
  } catch(e) { /* CORS hiba -> proxy */ }

  // PrÃ³ba 2: corsproxy
  const r2 = await fetch(CORS_PROXY + encodeURIComponent(SR_URL));
  if (!r2.ok) throw new Error(`Proxy hiba: ${r2.status}`);
  const html2 = await r2.text();
  const matches = parseMatches(html2);
  if (matches.length === 0) throw new Error('Nem talÃ¡lhatÃ³ meccs');
  return matches;
}

function parseMatches(html) {
  const matches = [];
  const parts = html.split(/<tr[^>]*cursor-pointer[^>]*>/);
  
  for (let i = 1; i < parts.length; i++) {
    const row = parts[i].split('</tr>')[0];
    
    // FordulÃ³
    const roundM = row.match(/>VLLM<\/div>\s*<div[^>]*>(\d+)<\/div>/);
    if (!roundM) continue;
    const round = parseInt(roundM[1]);
    
    // Csapatnevek
    const names = [...row.matchAll(/class="hidden-xs-up visible-sm-up wrap">([^<]+)<\/div>/g)].map(m => m[1].trim());
    if (names.length < 2) continue;
    
    // Logo ID-k
    const logoIds = [];
    for (const m of row.matchAll(/\/medium\/(\d{6})\.png/g)) {
      if (!logoIds.includes(m[1])) logoIds.push(m[1]);
    }
    
    // IdÅ‘pont
    const timeM = row.match(/<div class="text-center">\s*(\d{1,2}:\d{2})\s*<\/div>/);
    
    // EredmÃ©ny
    const scoreM = row.match(/aria-label="Eredm\."([\s\S]*?)<\/div><\/div><\/div>/);
    if (!scoreM) continue;
    const sec = scoreM[1];
    
    const dashes = [...sec.matchAll(/<div class="inline-block[^"]*">\s*-\s*<sup>/g)];
    const nums = [...sec.matchAll(/<div class="inline-block[^"]*">\s*(\d+)\s*<sup>/g)].map(m => parseInt(m[1]));
    
    // Csak lejÃ¡tszott meccseket veszÃ¼nk (ahol van eredmÃ©ny)
    if (dashes.length < 2 && nums.length >= 2) {
      matches.push({
        round,
        home: names[0],
        away: names[1],
        hid: logoIds[0] || null,
        aid: logoIds[1] || null,
        hs: nums[0],
        as: nums[1],
        time: timeM ? timeM[1] : null,
        timestamp: new Date().getTime() - (round * 3600000) // durva becslÃ©s
      });
    }
  }
  
  return matches;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2. Forma szÃ¡mÃ­tÃ¡s
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calculateForm(matches, matchCount = 5) {
  if (matches.length === 0) return [];
  
  // SzezonvÃ¡ltÃ¡s detektÃ¡lÃ¡s: ha az Ã¶sszpontszÃ¡m hirtelen lecsÃ¶kken
  const totalPts = matches.reduce((sum, m) => {
    return sum + (m.hs > m.as ? 3 : m.hs === m.as ? 1 : 0) + (m.as > m.hs ? 3 : m.as === m.hs ? 1 : 0);
  }, 0);
  
  if (lastPointsSum > 0 && totalPts < lastPointsSum * 0.3) {
    // Ãšj szezon! (pontok lenullÃ¡zÃ³dtak)
    currentSeason++;
    document.getElementById('seasonBadge').textContent = `ğŸ¯ Ãšj szezon (${currentSeason})`;
    document.getElementById('seasonBadge').classList.add('new');
  } else {
    document.getElementById('seasonBadge').textContent = `AktÃ­v szezon (${currentSeason})`;
    document.getElementById('seasonBadge').classList.remove('new');
  }
  lastPointsSum = totalPts;
  
  // Csapatok Ã¶sszegyÅ±jtÃ©se
  const teams = new Map();
  
  matches.forEach(m => {
    if (!teams.has(m.home)) {
      teams.set(m.home, { name: m.home, logo: m.hid, matches: [], points: 0, gf: 0, ga: 0 });
    }
    if (!teams.has(m.away)) {
      teams.set(m.away, { name: m.away, logo: m.aid, matches: [], points: 0, gf: 0, ga: 0 });
    }
    
    // Hazai csapat
    const homeTeam = teams.get(m.home);
    homeTeam.matches.push({
      opponent: m.away,
      gf: m.hs,
      ga: m.as,
      result: m.hs > m.as ? 'W' : m.hs === m.as ? 'D' : 'L',
      round: m.round
    });
    homeTeam.points += m.hs > m.as ? 3 : m.hs === m.as ? 1 : 0;
    homeTeam.gf += m.hs;
    homeTeam.ga += m.as;
    
    // VendÃ©g csapat
    const awayTeam = teams.get(m.away);
    awayTeam.matches.push({
      opponent: m.home,
      gf: m.as,
      ga: m.hs,
      result: m.as > m.hs ? 'W' : m.as === m.hs ? 'D' : 'L',
      round: m.round
    });
    awayTeam.points += m.as > m.hs ? 3 : m.as === m.hs ? 1 : 0;
    awayTeam.gf += m.as;
    awayTeam.ga += m.hs;
  });
  
  // Forma szÃ¡mÃ­tÃ¡s (utolsÃ³ N meccs)
  const formResults = [];
  
  for (const [name, team] of teams) {
    // UtolsÃ³ meccsek idÅ‘rendben
    const sortedMatches = team.matches.sort((a, b) => b.round - a.round);
    const lastN = sortedMatches.slice(0, matchCount);
    
    if (lastN.length === 0) continue;
    
    // Forma string (W/D/L)
    const formStr = lastN.map(m => m.result).join('');
    
    // Pontok az utolsÃ³ N meccsen
    const pts = lastN.reduce((sum, m) => {
      return sum + (m.result === 'W' ? 3 : m.result === 'D' ? 1 : 0);
    }, 0);
    
    // Ãtlag pont/meccs
    const avgPts = pts / lastN.length;
    
    // Trend szÃ¡mÃ­tÃ¡s (utolsÃ³ 3 vs elÅ‘tte 3)
    let trend = 'same';
    if (lastN.length >= 6) {
      const last3 = lastN.slice(0, 3).filter(m => m).reduce((s, m) => s + (m.result === 'W' ? 3 : m.result === 'D' ? 1 : 0), 0);
      const prev3 = lastN.slice(3, 6).filter(m => m).reduce((s, m) => s + (m.result === 'W' ? 3 : m.result === 'D' ? 1 : 0), 0);
      if (last3 > prev3) trend = 'up';
      else if (last3 < prev3) trend = 'down';
    }
    
    formResults.push({
      pos: 0, // majd rendezÃ©s utÃ¡n
      team: name,
      logo: team.logo ? `${LOGO_BASE}${team.logo}.png` : null,
      form: formStr,
      pts: pts,
      avgPts: avgPts,
      matchesCount: lastN.length,
      trend: trend,
      totalPts: team.points,
      gd: team.gf - team.ga
    });
  }
  
  // RendezÃ©s Ã¡tlag pont/meccs szerint
  const sorted = formResults.sort((a, b) => {
    if (b.avgPts !== a.avgPts) return b.avgPts - a.avgPts;
    return b.gd - a.gd; // gÃ³lkÃ¼lÃ¶nbsÃ©g mÃ¡sodlagos
  });
  
  // PozÃ­ciÃ³k beÃ¡llÃ­tÃ¡sa
  sorted.forEach((team, idx) => { team.pos = idx + 1; });
  
  return sorted;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 3. UI frissÃ­tÃ©s
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFormTable(data) {
  const table = document.getElementById('formTable');
  const meta = document.getElementById('formMeta');
  const updateTime = document.getElementById('updateTime');
  
  if (data.length === 0) {
    table.innerHTML = '<div style="padding:20px;text-align:center;color:#555">Nincs elegendÅ‘ adat</div>';
    meta.className = 'lb-meta error';
    meta.querySelector('span:first-child').innerHTML = '<span class="refresh-dot"></span>Nincs adat';
    updateTime.textContent = new Date().toLocaleTimeString('hu-HU');
    return;
  }
  
  const html = data.map(team => {
    const rowClass = team.pos <= 3 ? 'lb-row top3' : 
                     team.pos >= data.length - 2 ? 'lb-row bottom3' : 'lb-row';
    
    const trendIcon = team.trend === 'up' ? '<span class="trend-up">â–²</span>' :
                      team.trend === 'down' ? '<span class="trend-down">â–¼</span>' :
                      '<span class="trend-same">â€”</span>';
    
    const formDisplay = team.form
      .replace(/W/g, '<span style="color:#4caf50">W</span>')
      .replace(/D/g, '<span style="color:#f59e0b">D</span>')
      .replace(/L/g, '<span style="color:#e53935">L</span>');
    
    return `
      <div class="${rowClass}">
        <span class="col-pos">${team.pos}</span>
        <span class="col-team">
          ${team.logo ? `<img class="team-logo" src="${team.logo}" onerror="this.style.display='none'">` : '<span class="team-logo-placeholder"></span>'}
          <span class="team-name">${team.team}</span>
          ${trendIcon}
        </span>
        <span class="col-form">${formDisplay}</span>
        <span class="col-avg">${team.avgPts.toFixed(2)}</span>
        <span class="col-pts">${team.pts}</span>
      </div>
    `;
  }).join('');
  
  table.innerHTML = html;
  meta.className = 'lb-meta';
  meta.querySelector('span:first-child').innerHTML = '<span class="refresh-dot"></span>Forma alapÃº rangsor';
  updateTime.textContent = new Date().toLocaleTimeString('hu-HU');
  
  // StatisztikÃ¡k frissÃ­tÃ©se
  if (data.length > 0) {
    document.getElementById('bestTeamStat').textContent = data[0].team;
    
    const top5Avg = data.slice(0, 5).reduce((sum, t) => sum + t.avgPts, 0) / Math.min(5, data.length);
    document.getElementById('avgPtsStat').innerHTML = `${top5Avg.toFixed(2)} <small>(top5)</small>`;
    
    document.getElementById('matchesCountStat').textContent = allMatches.length;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 4. AI elemzÃ©s
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateAnalysis(formData, matchCount) {
  const body = document.getElementById('aiBody');
  const panel = document.getElementById('aiPanel');
  const errorBox = document.getElementById('errorBox');
  
  panel.classList.add('show');
  errorBox.classList.remove('show');
  body.className = 'aibody typing';
  body.innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
  
  // Prompt Ã¶sszeÃ¡llÃ­tÃ¡sa
  const top3 = formData.slice(0, 3);
  const bottom3 = formData.slice(-3);
  
  let prompt = `Te egy VirtuÃ¡lis LabdarÃºgÃ¡s Liga (VLLM) szakÃ©rtÅ‘ elemzÅ‘je vagy. 
Elemezd a csapatok aktuÃ¡lis formÃ¡jÃ¡t az utolsÃ³ ${matchCount} meccs alapjÃ¡n!

LEGJOBB FORMÃBAN (top 3):
${top3.map(t => `  â€¢ ${t.team}: ${t.form} (${t.avgPts.toFixed(2)} pont/meccs, Ã¶sszesen ${t.pts} pont)`).join('\n')}

LEGGYENGÃ‰BB FORMÃBAN (bottom 3):
${bottom3.map(t => `  â€¢ ${t.team}: ${t.form} (${t.avgPts.toFixed(2)} pont/meccs, Ã¶sszesen ${t.pts} pont)`).join('\n')}

Ã–SSZES MECCS: ${allMatches.length} lejÃ¡tszott meccs

KÃ©rlek adj egy rÃ¶vid elemzÃ©st a kÃ¶vetkezÅ‘ struktÃºrÃ¡ban:
1. ğŸ”¥ **Forma kirÃ¡ly** â€“ ki a legjobb Ã©s miÃ©rt?
2. ğŸ“ˆ **Legnagyobb javulÃ¡s** â€“ melyik csapat ment fel a legtÃ¶bbet?
3. ğŸ“‰ **ZuhanÃ³ csillag** â€“ ki vesztett a legtÃ¶bbet?
4. âš¡ **MeglepetÃ©s** â€“ egy vÃ¡ratlan eredmÃ©ny vagy trend
5. ğŸ¯ **Tipp a kÃ¶vetkezÅ‘ kÃ¶rre** â€“ egy konkrÃ©t javaslat

VÃ¡laszolj MAGYARUL, tÃ¶mÃ¶ren, max 250 szÃ³.`;
  
  try {
    const r = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`,
      {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          contents: [{parts: [{text: prompt}]}],
          generationConfig: {temperature: 0.6, maxOutputTokens: 800}
        })
      }
    );
    
    if (!r.ok) {
      const e = await r.json().catch(() => ({}));
      throw new Error(e?.error?.message || `HTTP ${r.status}`);
    }
    
    const data = await r.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error('Ãœres vÃ¡lasz');
    
    body.className = 'aibody';
    body.innerHTML = formatAnalysis(text);
    
  } catch(e) {
    errorBox.textContent = `âš ï¸ AI hiba: ${e.message}`;
    errorBox.classList.add('show');
    body.innerHTML = '<div style="color:#666">ElemzÃ©s nem elÃ©rhetÅ‘</div>';
  }
}

function formatAnalysis(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/^#{1,3}\s*(.+)$/gm, '<h3 style="margin:12px 0 6px;color:#4caf50;font-size:.85rem">$1</h3>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^<br>|<br>$/g, '');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 5. FÅ‘ betÃ¶ltÅ‘ fÃ¼ggvÃ©ny
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  const meta = document.getElementById('formMeta');
  const matchCount = parseInt(document.getElementById('matchCountSelect').value);
  
  meta.className = 'lb-meta loading';
  meta.querySelector('span:first-child').innerHTML = '<span class="refresh-dot"></span>BetÃ¶ltÃ©s...';
  
  try {
    // Meccsek betÃ¶ltÃ©se
    allMatches = await fetchMatches();
    
    if (allMatches.length === 0) {
      throw new Error('Nincs elÃ©rhetÅ‘ meccs');
    }
    
    // Forma szÃ¡mÃ­tÃ¡s
    formData = calculateForm(allMatches, matchCount);
    
    // TÃ¡blÃ¡zat renderelÃ©s
    renderFormTable(formData);
    
    // AI elemzÃ©s (ha van adat)
    if (formData.length >= 3) {
      generateAnalysis(formData, matchCount);
    }
    
  } catch(e) {
    const errorBox = document.getElementById('errorBox');
    errorBox.textContent = `âŒ ${e.message}`;
    errorBox.classList.add('show');
    
    meta.className = 'lb-meta error';
    meta.querySelector('span:first-child').innerHTML = '<span class="refresh-dot"></span>Hiba';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 6. InicializÃ¡lÃ¡s Ã©s event listenerek
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  
  // Automatikus frissÃ­tÃ©s 30 mÃ¡sodpercenkÃ©nt
  setInterval(loadData, 30000);
  
  // Select vÃ¡ltozÃ¡skor ÃºjraszÃ¡molÃ¡s
  document.getElementById('matchCountSelect').addEventListener('change', () => {
    const matchCount = parseInt(document.getElementById('matchCountSelect').value);
    if (allMatches.length > 0) {
      formData = calculateForm(allMatches, matchCount);
      renderFormTable(formData);
      generateAnalysis(formData, matchCount);
    }
  });
});
</script>

</body>
</html>
